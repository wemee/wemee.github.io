---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout 
  title="çœéŒ¢è­‰ä»¶ç…§è£½é€ æ©Ÿ | æŒ«å±å‹‡çš„å¯¦ç”¨å·¥å…·" 
  description="è‡ªå·±æ’ç‰ˆå¤§é ­ç…§ï¼Œå»è¶…å•†å°ä¸€å¼µ 4x6 åªè¦ 6 å¡ŠéŒ¢ï¼ç´”ç€è¦½å™¨è™•ç†ï¼Œç…§ç‰‡ä¸ä¸Šå‚³ä¼ºæœå™¨ã€‚"
>
  <Navbar currentPage="tools" />
  
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="/libs/cropperjs/cropper.min.css">
  
  <div class="container mt-4">
    <h1 class="mb-3">ğŸ“· çœéŒ¢è­‰ä»¶ç…§è£½é€ æ©Ÿ</h1>
    
    <!-- é–‹ç™¼æ•…äº‹ -->
    <div class="alert alert-success border-0 shadow-sm mb-4">
      <h5 class="alert-heading fw-bold">ğŸ’° è¶…å•†å°ä¸€çµ„åªè¦ 6~10 å…ƒï¼</h5>
      <p class="mb-0">
        ç…§ç›¸é¤¨æ´—ä¸€çµ„å¤§é ­ç…§è¦å¥½å¹¾ç™¾ï¼Ÿè‡ªå·±è£å¥½ã€æ’ç‰ˆï¼Œå»è¶…å•†é¸ã€Œ4x6 ç”Ÿæ´»ç…§åˆ—å°ã€å°±æå®šï¼<br>
        <strong>ä¸€å¼µ 4x6 å¯ä»¥å° 8 å¼µ 2 å‹å¤§é ­ç…§ï¼ŒèŠ±è²»ä¸åˆ° 10 å¡ŠéŒ¢ã€‚</strong>
      </p>
    </div>

    <!-- ä¸Šå‚³å€ -->
    <div id="uploadArea" class="upload-area mb-4">
      <div class="upload-content">
        <div class="upload-icon">ğŸ“</div>
        <p class="mb-2">ä¸Šå‚³ä½ çš„å¤§é ­ç…§åŸåœ–</p>
        <p class="text-muted small">å»ºè­°ä½¿ç”¨é«˜è§£æåº¦ç…§ç‰‡ä»¥ç²å¾—æœ€ä½³åˆ—å°æ•ˆæœ</p>
        <input type="file" id="fileInput" accept="image/*" class="d-none">
      </div>
    </div>

    <!-- ç·¨è¼¯å€ (é è¨­éš±è—) -->
    <div id="editorArea" class="d-none">
      <div class="row">
        <!-- å·¦å´ï¼šåœ–ç‰‡è£åˆ‡ -->
        <div class="col-lg-6 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><span class="step-badge">1</span> è£åˆ‡å¤§é ­ç…§</span>
              <div class="btn-group btn-group-sm" role="group">
                <button type="button" id="zoomOutBtn" class="btn btn-outline-light" title="ç¸®å°">â–</button>
                <button type="button" id="zoomInBtn" class="btn btn-outline-light" title="æ”¾å¤§">â•</button>
                <button type="button" id="zoomResetBtn" class="btn btn-outline-light" title="é‡è¨­">â†º</button>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="cropper-container-wrapper">
                <img id="previewImage" src="" alt="é è¦½">
              </div>
            </div>
            <div class="card-footer">
              <small class="text-muted">ğŸ’¡ æ»‘é¼ æ»¾è¼ªç¸®æ”¾ï¼Œå°‡è‡‰éƒ¨å°æº–æ¡†æ¡†</small>
            </div>
          </div>
        </div>
        
        <!-- å³å´ï¼šè¨­å®šèˆ‡é è¦½ -->
        <div class="col-lg-6">
          <!-- å°ºå¯¸è¨­å®š -->
          <div class="card mb-3">
            <div class="card-header"><span class="step-badge">2</span> é¸æ“‡å°ºå¯¸</div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label small">è­‰ä»¶ç…§å°ºå¯¸</label>
                <select id="photoSize" class="form-select">
                  <option value="2inch" selected>2 å‹å¤§é ­ç…§ (3.5cm Ã— 4.5cm) - èº«åˆ†è­‰/è­·ç…§</option>
                  <option value="1inch">1 å‹ (2.5cm Ã— 3cm) - é§•ç…§/åŸ·ç…§</option>
                  <option value="2inch-half">2 å‹åŠèº« (3.5cm Ã— 5cm) - å±¥æ­·/å¥ä¿å¡</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label small">è¼¸å‡ºç›¸ç´™å°ºå¯¸</label>
                <select id="paperSize" class="form-select">
                  <option value="4x6" selected>4Ã—6 ç›¸ç‰‡ç´™ (è¶…å•†æ²–å°æ¨è–¦)</option>
                  <option value="a4">A4 ç´™å¼µ (å®¶ç”¨å°è¡¨æ©Ÿ)</option>
                </select>
              </div>
              <div class="form-check mb-2">
                <input class="form-check-input" type="checkbox" id="showCutLines" checked>
                <label class="form-check-label" for="showCutLines">
                  é¡¯ç¤ºè£å‰ªè¼”åŠ©ç·š
                </label>
              </div>
            </div>
          </div>
          
          <!-- æ’ç‰ˆé è¦½ -->
          <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span><span class="step-badge">3</span> æ’ç‰ˆé è¦½</span>
              <span id="photoCount" class="badge bg-info">8 å¼µ</span>
            </div>
            <div class="card-body text-center">
              <canvas id="previewCanvas" class="border rounded" style="max-width: 100%; height: auto;"></canvas>
              <p class="small text-muted mt-2 mb-0">é è¦½ç‚ºç¸®å°é¡¯ç¤ºï¼Œå¯¦éš›åˆ—å°ç‚º 300 DPI é«˜è§£æ</p>
            </div>
          </div>
          
          <!-- ä¸‹è¼‰æŒ‰éˆ• -->
          <button id="downloadBtn" class="btn btn-success w-100 btn-lg mb-2">
            â¬‡ï¸ ä¸‹è¼‰æ’ç‰ˆåœ–ç‰‡
          </button>
          
          <button id="resetBtn" class="btn btn-outline-secondary w-100">
            ğŸ”„ é‡æ–°é¸æ“‡ç…§ç‰‡
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .upload-area {
    border: 3px dashed var(--bs-success);
    border-radius: 1rem;
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(var(--bs-success-rgb), 0.05);
  }

  .upload-area:hover,
  .upload-area.dragover {
    background: rgba(var(--bs-success-rgb), 0.15);
    border-color: var(--bs-primary);
  }

  .upload-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .cropper-container-wrapper {
    max-height: 400px;
    overflow: hidden;
    background: #1a1a1a;
  }

  .cropper-container-wrapper img {
    display: block;
    max-width: 100%;
  }

  #previewCanvas {
    background: #fff;
  }

  /* Step badge */
  .step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    background: var(--bs-success);
    color: white;
    font-size: 0.8rem;
    font-weight: bold;
    margin-right: 0.5rem;
  }
</style>

<script is:inline src="/libs/cropperjs/cropper.min.js"></script>
<script is:inline>
  // ===== è­‰ä»¶ç…§å°ºå¯¸å¸¸æ•¸ (å–®ä½: cm) =====
  const PHOTO_SIZES = {
    '2inch': { width: 3.5, height: 4.5, name: '2å‹' },
    '1inch': { width: 2.5, height: 3.0, name: '1å‹' },
    '2inch-half': { width: 3.5, height: 5.0, name: '2å‹åŠèº«' }
  };
  
  const PAPER_SIZES = {
    '4x6': { width: 15.2, height: 10.2 },  // æ©«æ”¾
    'a4': { width: 29.7, height: 21.0 }    // æ©«æ”¾
  };
  
  const DPI = 300;
  const CM_TO_INCH = 0.393701;
  
  function cmToPixels(cm) {
    return Math.round(cm * CM_TO_INCH * DPI);
  }
  
  // ===== DOM Elements =====
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const editorArea = document.getElementById('editorArea');
  const previewImage = document.getElementById('previewImage');
  const photoSizeSelect = document.getElementById('photoSize');
  const paperSizeSelect = document.getElementById('paperSize');
  const showCutLinesCheckbox = document.getElementById('showCutLines');
  const previewCanvas = document.getElementById('previewCanvas');
  const photoCountBadge = document.getElementById('photoCount');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomResetBtn = document.getElementById('zoomResetBtn');

  
  // ===== State =====
  let cropper = null;
  let originalFile = null;

  // ===== Upload handlers =====
  uploadArea.addEventListener('click', () => fileInput.click());
  
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      handleFile(file);
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  function handleFile(file) {
    originalFile = file;
    const url = URL.createObjectURL(file);
    const img = new Image();
    
    img.onload = function() {
      previewImage.src = url;
      uploadArea.classList.add('d-none');
      editorArea.classList.remove('d-none');
      
      setTimeout(() => {
        if (cropper) {
          cropper.destroy();
        }
        
        // å–å¾—ç•¶å‰é¸æ“‡çš„è­‰ä»¶ç…§æ¯”ä¾‹
        const photoSize = PHOTO_SIZES[photoSizeSelect.value];
        const aspectRatio = photoSize.width / photoSize.height;
        
        cropper = new Cropper(previewImage, {
          viewMode: 1,
          dragMode: 'move',
          aspectRatio: aspectRatio,
          autoCropArea: 0.8,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          ready: function() {
            updatePreview();
          },
          crop: function() {
            updatePreview();
          }
        });
      }, 100);
    };
    
    img.onerror = function() {
      alert('ç„¡æ³•è®€å–åœ–ç‰‡ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
      URL.revokeObjectURL(url);
    };
    
    img.src = url;
  }

  // ===== å°ºå¯¸è®Šæ›´ =====
  photoSizeSelect.addEventListener('change', function() {
    if (!cropper) return;
    const photoSize = PHOTO_SIZES[this.value];
    cropper.setAspectRatio(photoSize.width / photoSize.height);
    updatePreview();
  });
  
  paperSizeSelect.addEventListener('change', updatePreview);
  showCutLinesCheckbox.addEventListener('change', updatePreview);

  // ===== Zoom buttons =====
  zoomOutBtn.addEventListener('click', function() {
    if (!cropper) return;
    cropper.zoom(-0.1);
  });

  zoomInBtn.addEventListener('click', function() {
    if (!cropper) return;
    cropper.zoom(0.1);
  });

  zoomResetBtn.addEventListener('click', function() {
    if (!cropper) return;
    cropper.zoomTo(1);
  });


  // ===== è¨ˆç®—æ’ç‰ˆ =====
  function calculateLayout() {
    const photoSize = PHOTO_SIZES[photoSizeSelect.value];
    const paperSize = PAPER_SIZES[paperSizeSelect.value];
    
    // è¨ˆç®—å¯ä»¥æ”¾å¹¾å¼µ (åŠ ä¸Šé–“è· 0.2cm)
    const gap = 0.2;
    const cols = Math.floor(paperSize.width / (photoSize.width + gap));
    const rows = Math.floor(paperSize.height / (photoSize.height + gap));
    
    return {
      cols: cols,
      rows: rows,
      total: cols * rows,
      photoWidth: cmToPixels(photoSize.width),
      photoHeight: cmToPixels(photoSize.height),
      paperWidth: cmToPixels(paperSize.width),
      paperHeight: cmToPixels(paperSize.height),
      gapPixels: cmToPixels(gap)
    };
  }

  // ===== æ›´æ–°é è¦½ =====
  let previewTimeout = null;
  function updatePreview() {
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(doUpdatePreview, 300);
  }
  
  function doUpdatePreview() {
    if (!cropper) return;
    
    const layout = calculateLayout();
    photoCountBadge.textContent = layout.total + ' å¼µ';
    
    // è¨­å®š Canvas å°ºå¯¸ (é è¦½ç”¨ï¼Œç¸®å°é¡¯ç¤º)
    const scale = 0.3; // é è¦½ç¸®æ”¾æ¯”ä¾‹
    previewCanvas.width = layout.paperWidth * scale;
    previewCanvas.height = layout.paperHeight * scale;
    
    const ctx = previewCanvas.getContext('2d');
    
    // ç™½åº•
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
    
    // å–å¾—è£åˆ‡å¾Œçš„åœ–ç‰‡
    const croppedCanvas = cropper.getCroppedCanvas({
      width: layout.photoWidth,
      height: layout.photoHeight
    });
    
    if (!croppedCanvas) return;
    
    const showLines = showCutLinesCheckbox.checked;
    
    // è¨ˆç®—ç½®ä¸­çš„èµ·å§‹ä½ç½®
    const totalPhotosWidth = layout.cols * layout.photoWidth + (layout.cols - 1) * layout.gapPixels;
    const totalPhotosHeight = layout.rows * layout.photoHeight + (layout.rows - 1) * layout.gapPixels;
    const startX = (layout.paperWidth - totalPhotosWidth) / 2;
    const startY = (layout.paperHeight - totalPhotosHeight) / 2;
    
    // ç¹ªè£½æ¯å¼µç…§ç‰‡
    for (let row = 0; row < layout.rows; row++) {
      for (let col = 0; col < layout.cols; col++) {
        const x = startX + col * (layout.photoWidth + layout.gapPixels);
        const y = startY + row * (layout.photoHeight + layout.gapPixels);
        
        ctx.drawImage(
          croppedCanvas,
          x * scale,
          y * scale,
          layout.photoWidth * scale,
          layout.photoHeight * scale
        );
        
        // ç¹ªè£½è£å‰ªç·š
        if (showLines) {
          ctx.strokeStyle = '#CCCCCC';
          ctx.lineWidth = 1;
          ctx.strokeRect(
            x * scale,
            y * scale,
            layout.photoWidth * scale,
            layout.photoHeight * scale
          );
        }
      }
    }
  }

  // ===== ä¸‹è¼‰ =====
  downloadBtn.addEventListener('click', function() {
    if (!cropper) return;
    
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'â³ ç”¢ç”Ÿä¸­...';
    
    try {
      const layout = calculateLayout();
      
      // å»ºç«‹å®Œæ•´å°ºå¯¸çš„ Canvas
      const canvas = document.createElement('canvas');
      canvas.width = layout.paperWidth;
      canvas.height = layout.paperHeight;
      const ctx = canvas.getContext('2d');
      
      // ç™½åº•
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // å–å¾—è£åˆ‡å¾Œçš„åœ–ç‰‡
      const croppedCanvas = cropper.getCroppedCanvas({
        width: layout.photoWidth,
        height: layout.photoHeight
      });
      
      const showLines = showCutLinesCheckbox.checked;
      
      // è¨ˆç®—ç½®ä¸­
      const totalPhotosWidth = layout.cols * layout.photoWidth + (layout.cols - 1) * layout.gapPixels;
      const totalPhotosHeight = layout.rows * layout.photoHeight + (layout.rows - 1) * layout.gapPixels;
      const startX = (layout.paperWidth - totalPhotosWidth) / 2;
      const startY = (layout.paperHeight - totalPhotosHeight) / 2;
      
      // ç¹ªè£½æ¯å¼µç…§ç‰‡
      for (let row = 0; row < layout.rows; row++) {
        for (let col = 0; col < layout.cols; col++) {
          const x = startX + col * (layout.photoWidth + layout.gapPixels);
          const y = startY + row * (layout.photoHeight + layout.gapPixels);
          
          ctx.drawImage(croppedCanvas, x, y, layout.photoWidth, layout.photoHeight);
          
          if (showLines) {
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, layout.photoWidth, layout.photoHeight);
          }
        }
      }
      
      // ä¸‹è¼‰
      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'id_photo_' + paperSizeSelect.value + '.jpg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        downloadBtn.disabled = false;
        downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰æ’ç‰ˆåœ–ç‰‡';
      }, 'image/jpeg', 0.95);
      
    } catch (error) {
      console.error('Error:', error);
      alert('ç”¢ç”Ÿåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤');
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰æ’ç‰ˆåœ–ç‰‡';
    }
  });

  // ===== é‡è¨­ =====
  resetBtn.addEventListener('click', function() {
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    originalFile = null;
    previewImage.src = '';
    fileInput.value = '';
    editorArea.classList.add('d-none');
    uploadArea.classList.remove('d-none');
    
    // æ¸…é™¤ Canvas
    const ctx = previewCanvas.getContext('2d');
    ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
  });
</script>
