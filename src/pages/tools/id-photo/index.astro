---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout 
  title="çœéŒ¢è­‰ä»¶ç…§è£½é€ æ©Ÿ | æŒ«å±å‹‡çš„å¯¦ç”¨å·¥å…·" 
  description="è‡ªå·±æ’ç‰ˆå¤§é ­ç…§ï¼Œå»è¶…å•†å°ä¸€å¼µ 4x6 åªè¦ 6 å¡ŠéŒ¢ï¼ç´”ç€è¦½å™¨è™•ç†ï¼Œç…§ç‰‡ä¸ä¸Šå‚³ä¼ºæœå™¨ã€‚"
>
  <Navbar currentPage="tools" />
  
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="/libs/cropperjs/cropper.min.css">
  
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <h1 class="text-3xl font-bold text-base-50 mb-4">ğŸ“· çœéŒ¢è­‰ä»¶ç…§è£½é€ æ©Ÿ</h1>
    
    <!-- é–‹ç™¼æ•…äº‹ -->
    <div class="bg-accent-green/20 border border-accent-green rounded-lg p-4 mb-6">
      <h5 class="font-bold text-accent-green mb-1">ğŸ’° è¶…å•†å°ä¸€çµ„åªè¦ 6~10 å…ƒï¼</h5>
      <p class="text-base-400">
        ç…§ç›¸é¤¨æ´—ä¸€çµ„å¤§é ­ç…§è¦å¥½å¹¾ç™¾ï¼Ÿè‡ªå·±è£å¥½ã€æ’ç‰ˆï¼Œå»è¶…å•†é¸ã€Œ4x6 ç”Ÿæ´»ç…§åˆ—å°ã€å°±æå®šï¼<br>
        <strong class="text-base-50">ä¸€å¼µ 4x6 å¯ä»¥å° 8 å¼µ 2 å‹å¤§é ­ç…§ï¼ŒèŠ±è²»ä¸åˆ° 10 å¡ŠéŒ¢ã€‚</strong>
      </p>
    </div>

    <!-- ä¸Šå‚³å€ -->
    <div id="uploadArea" class="border-2 border-dashed border-accent-green rounded-xl p-12 text-center cursor-pointer hover:bg-accent-green/10 transition mb-6">
      <div class="text-6xl mb-4">ğŸ“</div>
      <p class="text-base-400 mb-2">ä¸Šå‚³ä½ çš„å¤§é ­ç…§åŸåœ–</p>
      <p class="text-base-600 text-sm">å»ºè­°ä½¿ç”¨é«˜è§£æåº¦ç…§ç‰‡ä»¥ç²å¾—æœ€ä½³åˆ—å°æ•ˆæœ</p>
      <input type="file" id="fileInput" accept="image/*" class="hidden">
    </div>

    <!-- ç·¨è¼¯å€ (é è¨­éš±è—) -->
    <div id="editorArea" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- å·¦å´ï¼šåœ–ç‰‡è£åˆ‡ -->
        <div>
          <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
            <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center justify-between">
              <span class="flex items-center">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-green text-base-50 text-sm font-bold mr-2">1</span>
                è£åˆ‡å¤§é ­ç…§
              </span>
              <div class="flex">
                <button type="button" id="zoomOutBtn" class="px-2 py-1 border border-base-600 rounded-l text-base-400 hover:bg-base-600 transition" title="ç¸®å°">â–</button>
                <button type="button" id="zoomInBtn" class="px-2 py-1 border-y border-base-600 text-base-400 hover:bg-base-600 transition" title="æ”¾å¤§">â•</button>
                <button type="button" id="zoomResetBtn" class="px-2 py-1 border border-base-600 rounded-r text-base-400 hover:bg-base-600 transition" title="é‡è¨­">â†º</button>
              </div>
            </div>
            <div class="cropper-container-wrapper max-h-[400px] overflow-hidden bg-base-900">
              <img id="previewImage" src="" alt="é è¦½" class="block max-w-full">
            </div>
            <div class="px-4 py-3 border-t border-base-600">
              <small class="text-base-600">ğŸ’¡ æ»‘é¼ æ»¾è¼ªç¸®æ”¾ï¼Œå°‡è‡‰éƒ¨å°æº–æ¡†æ¡†</small>
            </div>
          </div>
        </div>
        
        <!-- å³å´ï¼šè¨­å®šèˆ‡é è¦½ -->
        <div class="space-y-4">
          <!-- å°ºå¯¸è¨­å®š -->
          <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
            <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-green text-base-50 text-sm font-bold mr-2">2</span>
              é¸æ“‡å°ºå¯¸
            </div>
            <div class="p-4 space-y-4">
              <div>
                <label class="block text-sm text-base-400 mb-1">è­‰ä»¶ç…§å°ºå¯¸</label>
                <select id="photoSize" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-green focus:outline-none">
                  <option value="2inch" selected>2 å‹å¤§é ­ç…§ (3.5cm Ã— 4.5cm) - èº«åˆ†è­‰/è­·ç…§</option>
                  <option value="1inch">1 å‹ (2.5cm Ã— 3cm) - é§•ç…§/åŸ·ç…§</option>
                  <option value="2inch-half">2 å‹åŠèº« (3.5cm Ã— 5cm) - å±¥æ­·/å¥ä¿å¡</option>
                </select>
              </div>
              <div>
                <label class="block text-sm text-base-400 mb-1">è¼¸å‡ºç›¸ç´™å°ºå¯¸</label>
                <select id="paperSize" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-green focus:outline-none">
                  <option value="4x6" selected>4Ã—6 ç›¸ç‰‡ç´™ (è¶…å•†æ²–å°æ¨è–¦)</option>
                  <option value="a4">A4 ç´™å¼µ (å®¶ç”¨å°è¡¨æ©Ÿ)</option>
                </select>
              </div>
              <label class="flex items-center gap-2 cursor-pointer">
                <input type="checkbox" id="showCutLines" checked class="w-4 h-4 rounded border-base-600 bg-base-900 text-accent-green">
                <span class="text-base-400">é¡¯ç¤ºè£å‰ªè¼”åŠ©ç·š</span>
              </label>
            </div>
          </div>
          
          <!-- æ’ç‰ˆé è¦½ -->
          <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
            <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center justify-between">
              <span class="flex items-center">
                <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-green text-base-50 text-sm font-bold mr-2">3</span>
                æ’ç‰ˆé è¦½
              </span>
              <span id="photoCount" class="px-2 py-1 bg-accent-cyan/20 text-accent-cyan rounded text-sm">8 å¼µ</span>
            </div>
            <div class="p-4 text-center">
              <canvas id="previewCanvas" class="border border-base-600 rounded bg-white" style="max-width: 100%; height: auto;"></canvas>
              <p class="text-sm text-base-600 mt-2">é è¦½ç‚ºç¸®å°é¡¯ç¤ºï¼Œå¯¦éš›åˆ—å°ç‚º 300 DPI é«˜è§£æ</p>
            </div>
          </div>
          
          <!-- ä¸‹è¼‰æŒ‰éˆ• -->
          <button id="downloadBtn" class="w-full px-4 py-3 rounded-lg bg-accent-green hover:bg-accent-green/80 text-base-50 font-bold text-lg transition">
            â¬‡ï¸ ä¸‹è¼‰æ’ç‰ˆåœ–ç‰‡
          </button>
          
          <button id="resetBtn" class="w-full px-4 py-2 rounded border border-base-600 text-base-400 hover:bg-base-600 transition">
            ğŸ”„ é‡æ–°é¸æ“‡ç…§ç‰‡
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Dragover state */
  #uploadArea.dragover {
    background: rgba(133, 153, 0, 0.15);
    border-color: var(--color-accent-blue);
  }
</style>

<script is:inline src="/libs/cropperjs/cropper.min.js"></script>
<script is:inline>
  // ===== è­‰ä»¶ç…§å°ºå¯¸å¸¸æ•¸ (å–®ä½: cm) =====
  const PHOTO_SIZES = {
    '2inch': { width: 3.5, height: 4.5, name: '2å‹' },
    '1inch': { width: 2.5, height: 3.0, name: '1å‹' },
    '2inch-half': { width: 3.5, height: 5.0, name: '2å‹åŠèº«' }
  };
  
  const PAPER_SIZES = {
    '4x6': { width: 15.2, height: 10.2 },
    'a4': { width: 29.7, height: 21.0 }
  };
  
  const DPI = 300;
  const CM_TO_INCH = 0.393701;
  
  function cmToPixels(cm) {
    return Math.round(cm * CM_TO_INCH * DPI);
  }
  
  // ===== DOM Elements =====
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const editorArea = document.getElementById('editorArea');
  const previewImage = document.getElementById('previewImage');
  const photoSizeSelect = document.getElementById('photoSize');
  const paperSizeSelect = document.getElementById('paperSize');
  const showCutLinesCheckbox = document.getElementById('showCutLines');
  const previewCanvas = document.getElementById('previewCanvas');
  const photoCountBadge = document.getElementById('photoCount');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomResetBtn = document.getElementById('zoomResetBtn');

  
  // ===== State =====
  let cropper = null;
  let originalFile = null;

  // ===== Upload handlers =====
  uploadArea.addEventListener('click', () => fileInput.click());
  
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      handleFile(file);
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  function handleFile(file) {
    originalFile = file;
    const url = URL.createObjectURL(file);
    const img = new Image();
    
    img.onload = function() {
      previewImage.src = url;
      uploadArea.classList.add('hidden');
      editorArea.classList.remove('hidden');
      
      setTimeout(() => {
        if (cropper) {
          cropper.destroy();
        }
        
        const photoSize = PHOTO_SIZES[photoSizeSelect.value];
        const aspectRatio = photoSize.width / photoSize.height;
        
        cropper = new Cropper(previewImage, {
          viewMode: 1,
          dragMode: 'move',
          aspectRatio: aspectRatio,
          autoCropArea: 0.8,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          ready: function() {
            updatePreview();
          },
          crop: function() {
            updatePreview();
          }
        });
      }, 100);
    };
    
    img.onerror = function() {
      alert('ç„¡æ³•è®€å–åœ–ç‰‡ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
      URL.revokeObjectURL(url);
    };
    
    img.src = url;
  }

  // ===== å°ºå¯¸è®Šæ›´ =====
  photoSizeSelect.addEventListener('change', function() {
    if (!cropper) return;
    const photoSize = PHOTO_SIZES[this.value];
    cropper.setAspectRatio(photoSize.width / photoSize.height);
    updatePreview();
  });
  
  paperSizeSelect.addEventListener('change', updatePreview);
  showCutLinesCheckbox.addEventListener('change', updatePreview);

  // ===== Zoom buttons =====
  zoomOutBtn.addEventListener('click', () => cropper && cropper.zoom(-0.1));
  zoomInBtn.addEventListener('click', () => cropper && cropper.zoom(0.1));
  zoomResetBtn.addEventListener('click', () => cropper && cropper.zoomTo(1));

  // ===== è¨ˆç®—æ’ç‰ˆ =====
  function calculateLayout() {
    const photoSize = PHOTO_SIZES[photoSizeSelect.value];
    const paperSize = PAPER_SIZES[paperSizeSelect.value];
    
    const gap = 0.2;
    const cols = Math.floor(paperSize.width / (photoSize.width + gap));
    const rows = Math.floor(paperSize.height / (photoSize.height + gap));
    
    return {
      cols: cols,
      rows: rows,
      total: cols * rows,
      photoWidth: cmToPixels(photoSize.width),
      photoHeight: cmToPixels(photoSize.height),
      paperWidth: cmToPixels(paperSize.width),
      paperHeight: cmToPixels(paperSize.height),
      gapPixels: cmToPixels(gap)
    };
  }

  // ===== æ›´æ–°é è¦½ =====
  let previewTimeout = null;
  function updatePreview() {
    clearTimeout(previewTimeout);
    previewTimeout = setTimeout(doUpdatePreview, 300);
  }
  
  function doUpdatePreview() {
    if (!cropper) return;
    
    const layout = calculateLayout();
    photoCountBadge.textContent = layout.total + ' å¼µ';
    
    const scale = 0.3;
    previewCanvas.width = layout.paperWidth * scale;
    previewCanvas.height = layout.paperHeight * scale;
    
    const ctx = previewCanvas.getContext('2d');
    
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
    
    const croppedCanvas = cropper.getCroppedCanvas({
      width: layout.photoWidth,
      height: layout.photoHeight
    });
    
    if (!croppedCanvas) return;
    
    const showLines = showCutLinesCheckbox.checked;
    
    const totalPhotosWidth = layout.cols * layout.photoWidth + (layout.cols - 1) * layout.gapPixels;
    const totalPhotosHeight = layout.rows * layout.photoHeight + (layout.rows - 1) * layout.gapPixels;
    const startX = (layout.paperWidth - totalPhotosWidth) / 2;
    const startY = (layout.paperHeight - totalPhotosHeight) / 2;
    
    for (let row = 0; row < layout.rows; row++) {
      for (let col = 0; col < layout.cols; col++) {
        const x = startX + col * (layout.photoWidth + layout.gapPixels);
        const y = startY + row * (layout.photoHeight + layout.gapPixels);
        
        ctx.drawImage(
          croppedCanvas,
          x * scale,
          y * scale,
          layout.photoWidth * scale,
          layout.photoHeight * scale
        );
        
        if (showLines) {
          ctx.strokeStyle = '#CCCCCC';
          ctx.lineWidth = 1;
          ctx.strokeRect(
            x * scale,
            y * scale,
            layout.photoWidth * scale,
            layout.photoHeight * scale
          );
        }
      }
    }
  }

  // ===== ä¸‹è¼‰ =====
  downloadBtn.addEventListener('click', function() {
    if (!cropper) return;
    
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'â³ ç”¢ç”Ÿä¸­...';
    
    try {
      const layout = calculateLayout();
      
      const canvas = document.createElement('canvas');
      canvas.width = layout.paperWidth;
      canvas.height = layout.paperHeight;
      const ctx = canvas.getContext('2d');
      
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      const croppedCanvas = cropper.getCroppedCanvas({
        width: layout.photoWidth,
        height: layout.photoHeight
      });
      
      const showLines = showCutLinesCheckbox.checked;
      
      const totalPhotosWidth = layout.cols * layout.photoWidth + (layout.cols - 1) * layout.gapPixels;
      const totalPhotosHeight = layout.rows * layout.photoHeight + (layout.rows - 1) * layout.gapPixels;
      const startX = (layout.paperWidth - totalPhotosWidth) / 2;
      const startY = (layout.paperHeight - totalPhotosHeight) / 2;
      
      for (let row = 0; row < layout.rows; row++) {
        for (let col = 0; col < layout.cols; col++) {
          const x = startX + col * (layout.photoWidth + layout.gapPixels);
          const y = startY + row * (layout.photoHeight + layout.gapPixels);
          
          ctx.drawImage(croppedCanvas, x, y, layout.photoWidth, layout.photoHeight);
          
          if (showLines) {
            ctx.strokeStyle = '#CCCCCC';
            ctx.lineWidth = 2;
            ctx.strokeRect(x, y, layout.photoWidth, layout.photoHeight);
          }
        }
      }
      
      canvas.toBlob(function(blob) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'id_photo_' + paperSizeSelect.value + '.jpg';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        downloadBtn.disabled = false;
        downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰æ’ç‰ˆåœ–ç‰‡';
      }, 'image/jpeg', 0.95);
      
    } catch (error) {
      console.error('Error:', error);
      alert('ç”¢ç”Ÿåœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤');
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰æ’ç‰ˆåœ–ç‰‡';
    }
  });

  // ===== é‡è¨­ =====
  resetBtn.addEventListener('click', function() {
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    originalFile = null;
    previewImage.src = '';
    fileInput.value = '';
    editorArea.classList.add('hidden');
    uploadArea.classList.remove('hidden');
    
    const ctx = previewCanvas.getContext('2d');
    ctx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);
  });
</script>
