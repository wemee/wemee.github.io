---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout
  title="QR Code å·¥å…· | æŒ«å±å‹‡çš„å¯¦ç”¨å·¥å…·"
  description="QR Code è§£ç¢¼èˆ‡ç”¢ç”Ÿå·¥å…·ã€‚ä¸Šå‚³åœ–ç‰‡è§£æ QR Codeï¼Œæˆ–è¼¸å…¥æ–‡å­—ç”¢ç”Ÿ QR Codeã€‚ç´”ç€è¦½å™¨è™•ç†ï¼Œè³‡æ–™ä¸ä¸Šå‚³ä¼ºæœå™¨ã€‚"
>
  <Navbar currentPage="tools" />

  <div class="container mt-4">
    <h1 class="mb-3">ğŸ“± QR Code å·¥å…·</h1>

    <!-- åŠŸèƒ½èªªæ˜ -->
    <div class="alert alert-info border-0 shadow-sm mb-4">
      <h5 class="alert-heading fw-bold">ğŸ”’ æ‰€æœ‰è™•ç†éƒ½åœ¨ç€è¦½å™¨å®Œæˆ</h5>
      <p class="mb-0">
        ä½ çš„åœ–ç‰‡å’Œæ–‡å­—<strong>ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</strong>ï¼Œæ”¾å¿ƒä½¿ç”¨ã€‚
      </p>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="decode-tab" data-bs-toggle="tab" data-bs-target="#decode-panel" type="button" role="tab">
          ğŸ“· è§£ç¢¼ QR Code
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="encode-tab" data-bs-toggle="tab" data-bs-target="#encode-panel" type="button" role="tab">
          âœ¨ ç”¢ç”Ÿ QR Code
        </button>
      </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- è§£ç¢¼ Panel -->
      <div class="tab-pane fade show active" id="decode-panel" role="tabpanel">
        <div class="row">
          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header">
                <span class="step-badge">1</span> ä¸Šå‚³åœ–ç‰‡
              </div>
              <div class="card-body">
                <div id="uploadArea" class="upload-area">
                  <div class="upload-icon">ğŸ“</div>
                  <p class="mb-2">æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡</p>
                  <p class="text-muted small mb-0">æ”¯æ´ JPGã€PNGã€æˆªåœ–</p>
                  <input type="file" id="fileInput" accept="image/*" class="d-none">
                </div>
                <!-- åœ–ç‰‡é è¦½ -->
                <div id="previewArea" class="d-none mt-3">
                  <img id="preview" class="img-fluid rounded" alt="é è¦½">
                  <button id="clearBtn" class="btn btn-sm btn-outline-secondary mt-2 w-100">æ¸…é™¤é‡é¸</button>
                </div>
              </div>
            </div>
          </div>

          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header">
                <span class="step-badge">2</span> è§£æçµæœ
              </div>
              <div class="card-body">
                <div id="decodeResult" class="result-area">
                  <p class="text-muted mb-0">å°šæœªè§£æä»»ä½• QR Code</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- éš±è—ç”¨ Canvas -->
        <canvas id="decodeCanvas" class="d-none"></canvas>
      </div>

      <!-- ç”¢ç”Ÿ Panel -->
      <div class="tab-pane fade" id="encode-panel" role="tabpanel">
        <div class="row">
          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header">
                <span class="step-badge">1</span> è¼¸å…¥å…§å®¹
              </div>
              <div class="card-body">
                <div class="mb-3">
                  <label class="form-label small">æ–‡å­—æˆ–ç¶²å€</label>
                  <textarea id="encodeInput" class="form-control" rows="3" placeholder="è¼¸å…¥è¦è½‰æ›çš„æ–‡å­—æˆ–ç¶²å€..."></textarea>
                </div>
                <div class="row g-2 mb-3">
                  <div class="col-6">
                    <label class="form-label small">å¤§å°</label>
                    <select id="qrSize" class="form-select form-select-sm">
                      <option value="4">å° (132px)</option>
                      <option value="6" selected>ä¸­ (198px)</option>
                      <option value="8">å¤§ (264px)</option>
                      <option value="10">ç‰¹å¤§ (330px)</option>
                    </select>
                  </div>
                  <div class="col-6">
                    <label class="form-label small">å®¹éŒ¯ç­‰ç´š</label>
                    <select id="qrErrorLevel" class="form-select form-select-sm">
                      <option value="L">L (7%)</option>
                      <option value="M" selected>M (15%)</option>
                      <option value="Q">Q (25%)</option>
                      <option value="H">H (30%)</option>
                    </select>
                  </div>
                </div>
                <button id="generateBtn" class="btn btn-primary w-100">
                  âœ¨ ç”¢ç”Ÿ QR Code
                </button>
              </div>
            </div>
          </div>

          <div class="col-lg-6 mb-4">
            <div class="card">
              <div class="card-header">
                <span class="step-badge">2</span> QR Code é è¦½
              </div>
              <div class="card-body text-center">
                <div id="qrOutput" class="qr-output">
                  <p class="text-muted mb-0">è¼¸å…¥å…§å®¹å¾Œé»æ“Šç”¢ç”Ÿ</p>
                </div>
                <div id="qrActions" class="d-none mt-3">
                  <button id="downloadQrBtn" class="btn btn-success">
                    â¬‡ï¸ ä¸‹è¼‰ PNG
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .upload-area {
    border: 3px dashed var(--bs-primary);
    border-radius: 1rem;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(var(--bs-primary-rgb), 0.05);
  }

  .upload-area:hover,
  .upload-area.dragover {
    background: rgba(var(--bs-primary-rgb), 0.15);
    border-color: var(--bs-success);
  }

  .upload-icon {
    font-size: 3rem;
    margin-bottom: 0.5rem;
  }

  /* Step badge */
  .step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    background: var(--bs-primary);
    color: white;
    font-size: 0.8rem;
    font-weight: bold;
    margin-right: 0.5rem;
  }

  /* Result area */
  .result-area {
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .result-content {
    word-break: break-all;
    padding: 1rem;
    background: rgba(0,0,0,0.2);
    border-radius: 0.5rem;
    font-family: monospace;
  }

  .result-actions {
    display: flex;
    gap: 0.5rem;
    margin-top: 1rem;
  }

  /* QR Output */
  .qr-output {
    min-height: 150px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .qr-output canvas {
    border: 4px solid white;
    border-radius: 0.5rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  }
</style>

<script is:inline src="/tools/qrcode/jsQR.min.js"></script>
<script is:inline src="/tools/qrcode/qrcode-generator.min.js"></script>
<script is:inline>
  // ===== Decode Elements =====
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const previewArea = document.getElementById('previewArea');
  const preview = document.getElementById('preview');
  const clearBtn = document.getElementById('clearBtn');
  const decodeResult = document.getElementById('decodeResult');
  const decodeCanvas = document.getElementById('decodeCanvas');
  const decodeCtx = decodeCanvas.getContext('2d');

  // ===== Encode Elements =====
  const encodeInput = document.getElementById('encodeInput');
  const qrSize = document.getElementById('qrSize');
  const qrErrorLevel = document.getElementById('qrErrorLevel');
  const generateBtn = document.getElementById('generateBtn');
  const qrOutput = document.getElementById('qrOutput');
  const qrActions = document.getElementById('qrActions');
  const downloadQrBtn = document.getElementById('downloadQrBtn');

  // ===== Decode: Upload handlers =====
  uploadArea.addEventListener('click', () => fileInput.click());

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      handleDecodeFile(file);
    }
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleDecodeFile(file);
  });

  clearBtn.addEventListener('click', () => {
    preview.src = '';
    fileInput.value = '';
    uploadArea.classList.remove('d-none');
    previewArea.classList.add('d-none');
    decodeResult.innerHTML = '<p class="text-muted mb-0">å°šæœªè§£æä»»ä½• QR Code</p>';
  });

  function handleDecodeFile(file) {
    const url = URL.createObjectURL(file);
    preview.src = url;
    uploadArea.classList.add('d-none');
    previewArea.classList.remove('d-none');

    const img = new Image();
    img.onload = function() {
      decodeCanvas.width = img.width;
      decodeCanvas.height = img.height;
      decodeCtx.drawImage(img, 0, 0);

      const imgData = decodeCtx.getImageData(0, 0, img.width, img.height);
      const code = jsQR(imgData.data, imgData.width, imgData.height);

      if (code) {
        showDecodeResult(code.data);
      } else {
        decodeResult.innerHTML = '<p class="text-warning mb-0">âš ï¸ æœªåµæ¸¬åˆ° QR Codeï¼Œè«‹ç¢ºèªåœ–ç‰‡æ¸…æ™°</p>';
      }

      URL.revokeObjectURL(url);
    };
    img.src = url;
  }

  function showDecodeResult(data) {
    const isUrl = /^https?:\/\//i.test(data);

    let html = '<div class="result-content">' + escapeHtml(data) + '</div>';
    html += '<div class="result-actions">';
    html += '<button class="btn btn-sm btn-outline-primary copy-btn" data-text="' + escapeAttr(data) + '">ğŸ“‹ è¤‡è£½</button>';
    if (isUrl) {
      html += '<a href="' + escapeAttr(data) + '" target="_blank" rel="noopener" class="btn btn-sm btn-outline-success">ğŸ”— é–‹å•Ÿé€£çµ</a>';
    }
    html += '</div>';

    decodeResult.innerHTML = html;

    // Add copy handler
    decodeResult.querySelector('.copy-btn').addEventListener('click', function() {
      navigator.clipboard.writeText(this.dataset.text).then(() => {
        this.textContent = 'âœ“ å·²è¤‡è£½';
        setTimeout(() => { this.textContent = 'ğŸ“‹ è¤‡è£½'; }, 2000);
      });
    });
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function escapeAttr(text) {
    return text.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  }

  // ===== Encode: Generate QR Code =====
  let currentQrCanvas = null;

  generateBtn.addEventListener('click', generateQrCode);
  encodeInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && e.ctrlKey) generateQrCode();
  });

  function generateQrCode() {
    const text = encodeInput.value.trim();
    if (!text) {
      qrOutput.innerHTML = '<p class="text-warning mb-0">è«‹è¼¸å…¥å…§å®¹</p>';
      qrActions.classList.add('d-none');
      return;
    }

    try {
      const typeNumber = 0; // Auto-detect
      const errorLevel = qrErrorLevel.value;
      const cellSize = parseInt(qrSize.value);

      const qr = qrcode(typeNumber, errorLevel);
      qr.addData(text);
      qr.make();

      // Create canvas
      const moduleCount = qr.getModuleCount();
      const size = moduleCount * cellSize;

      const canvas = document.createElement('canvas');
      canvas.width = size;
      canvas.height = size;
      const ctx = canvas.getContext('2d');

      // White background
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, size, size);

      // Draw modules
      ctx.fillStyle = '#000000';
      for (let row = 0; row < moduleCount; row++) {
        for (let col = 0; col < moduleCount; col++) {
          if (qr.isDark(row, col)) {
            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
          }
        }
      }

      currentQrCanvas = canvas;
      qrOutput.innerHTML = '';
      qrOutput.appendChild(canvas);
      qrActions.classList.remove('d-none');

    } catch (error) {
      console.error('QR generation error:', error);
      qrOutput.innerHTML = '<p class="text-danger mb-0">ç”¢ç”Ÿå¤±æ•—ï¼šå…§å®¹å¯èƒ½å¤ªé•·</p>';
      qrActions.classList.add('d-none');
    }
  }

  downloadQrBtn.addEventListener('click', () => {
    if (!currentQrCanvas) return;

    currentQrCanvas.toBlob((blob) => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'qrcode.png';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }, 'image/png');
  });
</script>
