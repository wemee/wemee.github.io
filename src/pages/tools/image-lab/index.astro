---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout 
  title="åœ–ç‰‡è™•ç†å·¥å»  | æŒ«å±å‹‡çš„å¯¦ç”¨å·¥å…·" 
  description="ç·šä¸Šåœ–ç‰‡å£“ç¸®ã€è£åˆ‡ã€ç¸®æ”¾å·¥å…·ã€‚ç´”ç€è¦½å™¨è™•ç†ï¼Œä½ çš„ç…§ç‰‡ä¸æœƒè¢«ä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼Œå®‰å¿ƒä½¿ç”¨ï¼"
>
  <Navbar currentPage="tools" />
  
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="/libs/cropperjs/cropper.min.css">
  
  <div class="container mt-4">
    <h1 class="mb-3">ğŸ–¼ï¸ åœ–ç‰‡è™•ç†å·¥å» </h1>
    
    <!-- é–‹ç™¼æ•…äº‹ -->
    <div class="alert alert-info border-0 shadow-sm mb-4">
      <h5 class="alert-heading fw-bold">ğŸ”’ ä½ çš„ç…§ç‰‡å¾ˆå®‰å…¨</h5>
      <p class="mb-0">
        å¡«è¡¨å–®ä¸Šå‚³è­‰ä»¶ç…§è¢«èªªã€Œæª”æ¡ˆå¤ªå¤§ã€ï¼Ÿç”¨é€™å€‹å·¥å…·å£“ç¸®ï¼<br>
        <strong>æ‰€æœ‰è™•ç†éƒ½åœ¨ä½ çš„ç€è¦½å™¨å®Œæˆï¼Œåœ–ç‰‡ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚</strong><br>
        æ”¾å¿ƒå£“ç¸®ä½ çš„èº«åˆ†è­‰ã€ä¿¡ç”¨å¡ç…§ç‰‡å§ï¼
      </p>
    </div>

    <!-- ä¸Šå‚³å€ -->
    <div id="uploadArea" class="upload-area mb-4">
      <div class="upload-content">
        <div class="upload-icon">ğŸ“</div>
        <p class="mb-2">æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
        <p class="text-muted small">æ”¯æ´ JPGã€PNGã€WebPã€GIF</p>
        <input type="file" id="fileInput" accept="image/*" class="d-none">
      </div>
    </div>

    <!-- ç·¨è¼¯å€ (é è¨­éš±è—) -->
    <div id="editorArea" class="d-none">
      <div class="row">
        <!-- å·¦å´ï¼šåœ–ç‰‡é è¦½ -->
        <div class="col-lg-8 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>åœ–ç‰‡é è¦½</span>
              <span id="originalInfo" class="badge bg-secondary"></span>
            </div>
            <div class="card-body p-0">
              <div class="cropper-container-wrapper">
                <img id="previewImage" src="" alt="é è¦½">
              </div>
            </div>
            <div class="card-footer">
              <small class="text-muted">ğŸ’¡ æ“ä½œæç¤ºï¼šæ‹–æ›³å¯ç§»å‹•åœ–ç‰‡ï¼Œ<strong>æ»‘é¼ æ»¾è¼ªå¯ç¸®æ”¾</strong>ï¼Œæ‹–æ‹‰é‚Šæ¡†èª¿æ•´è£åˆ‡ç¯„åœ</small>
            </div>
          </div>
        </div>
        
        <!-- å³å´ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="col-lg-4">
          <!-- è£åˆ‡è¨­å®š -->
          <div class="card mb-3">
            <div class="card-header">âœ‚ï¸ è£åˆ‡</div>
            <div class="card-body">
              <div class="btn-group w-100 mb-2" role="group">
                <button type="button" class="btn btn-outline-primary aspect-btn active" data-aspect="free">è‡ªç”±</button>
                <button type="button" class="btn btn-outline-primary aspect-btn" data-aspect="1">1:1</button>
                <button type="button" class="btn btn-outline-primary aspect-btn" data-aspect="1.778">16:9</button>
                <button type="button" class="btn btn-outline-primary aspect-btn" data-aspect="1.333">4:3</button>
              </div>
              <button id="resetCropBtn" class="btn btn-sm btn-outline-secondary w-100">é‡è¨­è£åˆ‡ç¯„åœ</button>
            </div>
          </div>
          
          <!-- ç¸®æ”¾è¨­å®š -->
          <div class="card mb-3">
            <div class="card-header">ğŸ“ ç¸®æ”¾</div>
            <div class="card-body">
              <div class="row g-2 align-items-center">
                <div class="col-5">
                  <label class="form-label small mb-1">å¯¬åº¦ (px)</label>
                  <input type="number" id="resizeWidth" class="form-control form-control-sm" placeholder="å¯¬">
                </div>
                <div class="col-2 text-center">
                  <button id="lockRatioBtn" class="btn btn-sm btn-outline-warning mt-3" title="é–å®š/è§£é–æ¯”ä¾‹">
                    ğŸ”’
                  </button>
                </div>
                <div class="col-5">
                  <label class="form-label small mb-1">é«˜åº¦ (px)</label>
                  <input type="number" id="resizeHeight" class="form-control form-control-sm" placeholder="é«˜">
                </div>
              </div>
              <div class="btn-group w-100 mt-2" role="group">
                <button type="button" class="btn btn-sm btn-outline-secondary scale-btn" data-scale="0.25">25%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary scale-btn" data-scale="0.5">50%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary scale-btn" data-scale="0.75">75%</button>
                <button type="button" class="btn btn-sm btn-outline-secondary scale-btn" data-scale="1">100%</button>
              </div>
            </div>
          </div>
          
          <!-- å£“ç¸®è¨­å®š -->
          <div class="card mb-3">
            <div class="card-header">ğŸ’¾ å£“ç¸®è¼¸å‡º</div>
            <div class="card-body">
              <div class="mb-3">
                <label class="form-label small">è¼¸å‡ºæ ¼å¼</label>
                <select id="outputFormat" class="form-select form-select-sm">
                  <option value="auto">âœ¨ è‡ªå‹•åµæ¸¬</option>
                  <option value="jpeg">JPG - ç…§ç‰‡é¦–é¸</option>
                  <option value="webp">WebP - ç¾ä»£é€šç”¨</option>
                  <option value="png">PNG - ç„¡å¤±çœŸ</option>
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label small d-flex justify-content-between">
                  <span>å“è³ª</span>
                  <span id="qualityValue">80%</span>
                </label>
                <input type="range" id="qualitySlider" class="form-range" min="10" max="100" value="80">
              </div>
              <div class="d-flex justify-content-between small text-muted">
                <span>åŸå§‹: <span id="originalSize">-</span></span>
                <span>é ä¼°: <span id="estimatedSize">-</span></span>
              </div>
            </div>
          </div>
          
          <!-- ä¸‹è¼‰æŒ‰éˆ• -->
          <button id="downloadBtn" class="btn btn-success w-100 btn-lg">
            â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡
          </button>
          
          <!-- é‡æ–°ä¸Šå‚³ -->
          <button id="resetBtn" class="btn btn-outline-secondary w-100 mt-2">
            ğŸ”„ é‡æ–°é¸æ“‡åœ–ç‰‡
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .upload-area {
    border: 3px dashed var(--bs-primary);
    border-radius: 1rem;
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(var(--bs-primary-rgb), 0.05);
  }
  
  .upload-area:hover,
  .upload-area.dragover {
    background: rgba(var(--bs-primary-rgb), 0.15);
    border-color: var(--bs-success);
  }
  
  .upload-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }
  
  .cropper-container-wrapper {
    max-height: 500px;
    overflow: hidden;
    background: #1a1a1a;
  }
  
  .cropper-container-wrapper img {
    display: block;
    max-width: 100%;
  }
  
  .aspect-btn.active {
    background-color: var(--bs-primary);
    color: white;
  }
</style>

<script is:inline src="/libs/cropperjs/cropper.min.js"></script>
<script is:inline>
  // ===== åœ–ç‰‡è™•ç†å‡½å¼ (å…§åµŒ) =====
  
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }
  
  function getSmartFormat(originalFile) {
    const type = originalFile.type.toLowerCase();
    if (type === 'image/jpeg' || type === 'image/jpg') {
      return 'jpeg';
    }
    return 'webp';
  }
  
  function getExtension(format) {
    return format === 'jpeg' ? 'jpg' : format;
  }
  
  function compressCanvas(canvas, format, quality) {
    return new Promise((resolve, reject) => {
      let targetCanvas = canvas;
      
      // PNG è½‰ JPG éœ€è¦å¡«ç™½åº•
      if (format === 'jpeg') {
        const newCanvas = document.createElement('canvas');
        const newCtx = newCanvas.getContext('2d');
        newCanvas.width = canvas.width;
        newCanvas.height = canvas.height;
        newCtx.fillStyle = '#FFFFFF';
        newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
        newCtx.drawImage(canvas, 0, 0);
        targetCanvas = newCanvas;
      }
      
      const mimeType = 'image/' + format;
      targetCanvas.toBlob(
        (blob) => {
          if (blob) resolve(blob);
          else reject(new Error('ç„¡æ³•å£“ç¸®åœ–ç‰‡'));
        },
        mimeType,
        quality
      );
    });
  }
  
  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ===== DOM Elements =====
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const editorArea = document.getElementById('editorArea');
  const previewImage = document.getElementById('previewImage');
  const aspectBtns = document.querySelectorAll('.aspect-btn');
  const resetCropBtn = document.getElementById('resetCropBtn');
  const resizeWidth = document.getElementById('resizeWidth');
  const resizeHeight = document.getElementById('resizeHeight');
  const lockRatioBtn = document.getElementById('lockRatioBtn');
  const scaleBtns = document.querySelectorAll('.scale-btn');
  const outputFormat = document.getElementById('outputFormat');
  const qualitySlider = document.getElementById('qualitySlider');
  const qualityValue = document.getElementById('qualityValue');
  const originalSize = document.getElementById('originalSize');
  const estimatedSize = document.getElementById('estimatedSize');
  const originalInfo = document.getElementById('originalInfo');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');

  // ===== State =====
  let cropper = null;
  let originalFile = null;
  let isRatioLocked = true;

  // ===== Upload handlers =====
  uploadArea.addEventListener('click', () => fileInput.click());
  
  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });
  
  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });
  
  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      handleFile(file);
    }
  });
  
  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  function handleFile(file) {
    originalFile = file;
    originalSize.textContent = formatFileSize(file.size);
    
    const url = URL.createObjectURL(file);
    const img = new Image();
    
    img.onload = function() {
      originalInfo.textContent = img.naturalWidth + ' Ã— ' + img.naturalHeight;
      resizeWidth.value = img.naturalWidth;
      resizeHeight.value = img.naturalHeight;
      
      previewImage.src = url;
      uploadArea.classList.add('d-none');
      editorArea.classList.remove('d-none');
      
      // ç­‰ DOM æ›´æ–°å¾Œåˆå§‹åŒ– Cropper
      setTimeout(() => {
        if (cropper) {
          cropper.destroy();
        }
        
        cropper = new Cropper(previewImage, {
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          ready: function() {
            updateEstimatedSize();
          },
          crop: function() {
            updateCropDimensions();
          }
        });
      }, 100);
    };
    
    img.onerror = function() {
      alert('ç„¡æ³•è®€å–åœ–ç‰‡ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
      URL.revokeObjectURL(url);
    };
    
    img.src = url;
  }

  // ===== Aspect ratio buttons =====
  aspectBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      aspectBtns.forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      
      const aspect = btn.dataset.aspect;
      if (aspect === 'free') {
        cropper.setAspectRatio(NaN);
      } else {
        cropper.setAspectRatio(parseFloat(aspect));
      }
    });
  });

  // ===== Reset crop =====
  resetCropBtn.addEventListener('click', function() {
    cropper.reset();
    aspectBtns.forEach(function(b) { b.classList.remove('active'); });
    aspectBtns[0].classList.add('active');
  });

  // ===== Lock ratio toggle =====
  lockRatioBtn.addEventListener('click', function() {
    isRatioLocked = !isRatioLocked;
    lockRatioBtn.textContent = isRatioLocked ? 'ğŸ”’' : 'ğŸ”“';
    lockRatioBtn.classList.toggle('btn-outline-warning', isRatioLocked);
    lockRatioBtn.classList.toggle('btn-outline-secondary', !isRatioLocked);
  });

  // ===== Resize inputs =====
  resizeWidth.addEventListener('input', function() {
    if (isRatioLocked && resizeWidth.value && cropper) {
      const cropData = cropper.getData();
      const cropRatio = cropData.width / cropData.height;
      resizeHeight.value = Math.round(parseInt(resizeWidth.value) / cropRatio);
    }
    updateEstimatedSize();
  });

  resizeHeight.addEventListener('input', function() {
    if (isRatioLocked && resizeHeight.value && cropper) {
      const cropData = cropper.getData();
      const cropRatio = cropData.width / cropData.height;
      resizeWidth.value = Math.round(parseInt(resizeHeight.value) * cropRatio);
    }
    updateEstimatedSize();
  });

  // ===== Scale buttons =====
  scaleBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      if (!cropper) return;
      const scale = parseFloat(btn.dataset.scale);
      const cropData = cropper.getData();
      resizeWidth.value = Math.round(cropData.width * scale);
      resizeHeight.value = Math.round(cropData.height * scale);
      updateEstimatedSize();
    });
  });

  // ===== Quality slider =====
  qualitySlider.addEventListener('input', function() {
    qualityValue.textContent = qualitySlider.value + '%';
    updateEstimatedSize();
  });

  // ===== Format change =====
  outputFormat.addEventListener('change', updateEstimatedSize);

  // ===== Update crop dimensions =====
  function updateCropDimensions() {
    if (!cropper) return;
    const data = cropper.getData();
    resizeWidth.value = Math.round(data.width);
    resizeHeight.value = Math.round(data.height);
  }

  // ===== Estimate output size =====
  let estimateTimeout = null;
  function updateEstimatedSize() {
    if (!cropper) return;
    
    // Debounce
    clearTimeout(estimateTimeout);
    estimateTimeout = setTimeout(async function() {
      try {
        const canvas = cropper.getCroppedCanvas({
          width: parseInt(resizeWidth.value) || undefined,
          height: parseInt(resizeHeight.value) || undefined
        });
        
        if (!canvas) return;
        
        let format = outputFormat.value;
        if (format === 'auto') {
          format = getSmartFormat(originalFile);
        }
        
        const quality = parseInt(qualitySlider.value) / 100;
        const blob = await compressCanvas(canvas, format, quality);
        estimatedSize.textContent = formatFileSize(blob.size);
        
      } catch (error) {
        console.error('Error estimating size:', error);
      }
    }, 300);
  }

  // ===== Download =====
  downloadBtn.addEventListener('click', async function() {
    if (!cropper) return;
    
    downloadBtn.disabled = true;
    downloadBtn.textContent = 'â³ è™•ç†ä¸­...';
    
    try {
      const canvas = cropper.getCroppedCanvas({
        width: parseInt(resizeWidth.value) || undefined,
        height: parseInt(resizeHeight.value) || undefined
      });
      
      let format = outputFormat.value;
      if (format === 'auto') {
        format = getSmartFormat(originalFile);
      }
      
      const quality = parseInt(qualitySlider.value) / 100;
      const blob = await compressCanvas(canvas, format, quality);
      
      const originalName = originalFile.name.replace(/\.[^/.]+$/, '');
      const extension = getExtension(format);
      const filename = originalName + '_processed.' + extension;
      
      downloadBlob(blob, filename);
      
    } catch (error) {
      console.error('Error processing:', error);
      alert('è™•ç†åœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤');
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡';
    }
  });

  // ===== Reset =====
  resetBtn.addEventListener('click', function() {
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    originalFile = null;
    previewImage.src = '';
    fileInput.value = '';
    editorArea.classList.add('d-none');
    uploadArea.classList.remove('d-none');
    
    resizeWidth.value = '';
    resizeHeight.value = '';
    qualitySlider.value = 80;
    qualityValue.textContent = '80%';
    outputFormat.value = 'auto';
    originalSize.textContent = '-';
    estimatedSize.textContent = '-';
    originalInfo.textContent = '';
    
    aspectBtns.forEach(function(b) { b.classList.remove('active'); });
    aspectBtns[0].classList.add('active');
  });
</script>
