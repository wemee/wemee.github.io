---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout
  title="åœ–ç‰‡è™•ç†å·¥å»  | æŒ«å±å‹‡çš„å¯¦ç”¨å·¥å…·"
  description="ç·šä¸Šåœ–ç‰‡å£“ç¸®ã€è£åˆ‡ã€ç¸®æ”¾å·¥å…·ã€‚ç´”ç€è¦½å™¨è™•ç†ï¼Œä½ çš„ç…§ç‰‡ä¸æœƒè¢«ä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼Œå®‰å¿ƒä½¿ç”¨ï¼"
>
  <Navbar currentPage="tools" />

  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="/libs/cropperjs/cropper.min.css">

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <h1 class="text-3xl font-bold text-base-50 mb-4">ğŸ–¼ï¸ åœ–ç‰‡è™•ç†å·¥å» </h1>

    <!-- å®‰å…¨æç¤º -->
    <div class="bg-accent-cyan/20 border border-accent-cyan rounded-lg p-4 mb-6">
      <h5 class="font-bold text-accent-cyan mb-1">ğŸ”’ ä½ çš„ç…§ç‰‡å¾ˆå®‰å…¨</h5>
      <p class="text-base-400">
        æ‰€æœ‰è™•ç†éƒ½åœ¨ç€è¦½å™¨å®Œæˆï¼Œåœ–ç‰‡<strong class="text-base-50">ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</strong>ã€‚
      </p>
    </div>

    <!-- ä¸Šå‚³å€ -->
    <div id="uploadArea" class="upload-area border-2 border-dashed border-accent-blue rounded-xl p-12 text-center cursor-pointer hover:bg-accent-blue/10 transition mb-6">
      <div class="text-6xl mb-4">ğŸ“</div>
      <p class="text-base-400 mb-2">æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
      <p class="text-base-600 text-sm">æ”¯æ´ JPGã€PNGã€WebPã€GIF</p>
      <input type="file" id="fileInput" accept="image/*" class="hidden">
    </div>

    <!-- ç·¨è¼¯å€ (é è¨­éš±è—) -->
    <div id="editorArea" class="hidden">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- å·¦å´ï¼šåœ–ç‰‡é è¦½ -->
        <div class="lg:col-span-2">
          <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
            <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center justify-between">
              <span class="text-base-50">ğŸ“· ç·¨è¼¯åœ–ç‰‡</span>
              <div class="flex items-center gap-2">
                <div class="flex">
                  <button type="button" id="zoomOutBtn" class="px-2 py-1 border border-base-600 rounded-l text-base-400 hover:bg-base-600 transition" title="ç¸®å°">â–</button>
                  <button type="button" id="zoomInBtn" class="px-2 py-1 border-y border-base-600 text-base-400 hover:bg-base-600 transition" title="æ”¾å¤§">â•</button>
                  <button type="button" id="zoomResetBtn" class="px-2 py-1 border border-base-600 rounded-r text-base-400 hover:bg-base-600 transition" title="é‡è¨­">â†º</button>
                </div>
                <span id="originalInfo" class="px-2 py-1 bg-base-600 rounded text-sm text-base-400"></span>
              </div>
            </div>
            <div class="cropper-container-wrapper max-h-[500px] overflow-hidden bg-base-900">
              <img id="previewImage" src="" alt="é è¦½" class="block max-w-full">
            </div>
            <div class="px-4 py-3 border-t border-base-600 flex items-center justify-between">
              <small class="text-base-600">ğŸ’¡ æ»‘é¼ æ»¾è¼ªç¸®æ”¾ï¼Œæ‹–æ‹‰é‚Šæ¡†èª¿æ•´è£åˆ‡</small>
              <span id="outputDimensions" class="px-2 py-1 bg-accent-cyan/20 text-accent-cyan rounded text-sm">-- Ã— -- px</span>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="space-y-4">
          <!-- æ­¥é©Ÿ 1ï¼šè£åˆ‡æ¯”ä¾‹ -->
          <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
            <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-blue text-base-50 text-sm font-bold mr-2">1</span>
              è£åˆ‡æ¯”ä¾‹
            </div>
            <div class="p-4">
              <div class="grid grid-cols-4 gap-2">
                <button type="button" class="aspect-btn active px-3 py-2 rounded border border-accent-blue bg-accent-blue text-base-50 text-sm transition" data-aspect="free">è‡ªç”±</button>
                <button type="button" class="aspect-btn px-3 py-2 rounded border border-base-600 text-base-400 hover:border-accent-blue text-sm transition" data-aspect="1">1:1</button>
                <button type="button" class="aspect-btn px-3 py-2 rounded border border-base-600 text-base-400 hover:border-accent-blue text-sm transition" data-aspect="1.778">16:9</button>
                <button type="button" class="aspect-btn px-3 py-2 rounded border border-base-600 text-base-400 hover:border-accent-blue text-sm transition" data-aspect="1.333">4:3</button>
              </div>
            </div>
          </div>

          <!-- æ­¥é©Ÿ 2ï¼šè¼¸å‡ºå¤§å° -->
          <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
            <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-blue text-base-50 text-sm font-bold mr-2">2</span>
              è¼¸å‡ºå¤§å°
            </div>
            <div class="p-4 space-y-2">
              <label class="size-option block cursor-pointer">
                <input type="radio" name="sizeMode" value="original" checked class="hidden">
                <span class="size-option-content flex flex-col p-3 border-2 border-base-600 rounded-lg transition">
                  <span class="font-medium text-base-50">åŸå§‹å¤§å°</span>
                  <span class="text-sm text-base-600">ç¶­æŒè£åˆ‡å¾Œçš„å°ºå¯¸</span>
                </span>
              </label>
              <label class="size-option block cursor-pointer">
                <input type="radio" name="sizeMode" value="half" class="hidden">
                <span class="size-option-content flex flex-col p-3 border-2 border-base-600 rounded-lg transition">
                  <span class="font-medium text-base-50">ç¸®å° 50%</span>
                  <span class="text-sm text-base-600">é©åˆä¸€èˆ¬åˆ†äº«</span>
                </span>
              </label>
              <label class="size-option block cursor-pointer">
                <input type="radio" name="sizeMode" value="custom" class="hidden">
                <span class="size-option-content flex flex-col p-3 border-2 border-base-600 rounded-lg transition">
                  <span class="font-medium text-base-50">æŒ‡å®šå¯¬åº¦</span>
                  <span class="text-sm text-base-600">è‡ªå‹•è¨ˆç®—é«˜åº¦</span>
                </span>
              </label>
              <!-- è‡ªè¨‚å¯¬åº¦è¼¸å…¥ -->
              <div id="customWidthArea" class="hidden mt-3">
                <div class="flex">
                  <input type="number" id="customWidth" class="flex-1 px-3 py-2 bg-base-900 border border-base-600 rounded-l text-base-50 focus:border-accent-blue focus:outline-none" placeholder="800" value="800">
                  <span class="px-3 py-2 bg-base-600 border border-base-600 rounded-r text-base-400">px</span>
                </div>
              </div>
            </div>
          </div>

          <!-- æ­¥é©Ÿ 3ï¼šè¼¸å‡ºæ ¼å¼ -->
          <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
            <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-blue text-base-50 text-sm font-bold mr-2">3</span>
              æ ¼å¼èˆ‡å“è³ª
            </div>
            <div class="p-4 space-y-3">
              <div class="grid grid-cols-2 gap-3">
                <select id="outputFormat" class="px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-blue focus:outline-none">
                  <option value="auto">è‡ªå‹•</option>
                  <option value="jpeg">JPG</option>
                  <option value="webp">WebP</option>
                  <option value="png">PNG</option>
                </select>
                <div class="flex items-center gap-2">
                  <input type="range" id="qualitySlider" class="flex-1" min="10" max="100" value="80">
                  <span id="qualityValue" class="text-sm text-base-400 w-10 text-right">80%</span>
                </div>
              </div>
              <div class="flex justify-center items-center gap-4 p-3 bg-black/20 rounded text-sm">
                <span class="text-base-400">åŸå§‹: <strong id="originalSize" class="text-base-50">-</strong></span>
                <span class="text-base-600">â†’</span>
                <span class="text-base-400">é ä¼°: <strong id="estimatedSize" class="text-accent-green">-</strong></span>
              </div>
            </div>
          </div>

          <!-- ä¸‹è¼‰æŒ‰éˆ• -->
          <button id="downloadBtn" class="w-full px-4 py-3 rounded-lg bg-accent-green hover:bg-accent-green/80 text-base-50 font-bold text-lg transition">
            â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡
          </button>

          <!-- é‡æ–°ä¸Šå‚³ -->
          <button id="resetBtn" class="w-full px-4 py-2 rounded border border-base-600 text-base-400 hover:bg-base-600 transition">
            ğŸ”„ é‡æ–°é¸æ“‡åœ–ç‰‡
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  /* Size option radio card style */
  .size-option input:checked + .size-option-content {
    border-color: var(--color-accent-blue);
    background: rgba(38, 139, 210, 0.1);
  }

  .size-option-content:hover {
    border-color: var(--color-accent-blue);
  }

  /* Aspect button active state */
  .aspect-btn.active {
    background-color: var(--color-accent-blue);
    border-color: var(--color-accent-blue);
    color: var(--color-base-50);
  }

  .aspect-btn:not(.active):hover {
    border-color: var(--color-accent-blue);
    color: var(--color-base-50);
  }

  /* Dragover state */
  .upload-area.dragover {
    background: rgba(38, 139, 210, 0.15);
    border-color: var(--color-accent-green);
  }
</style>

<script is:inline src="/libs/cropperjs/cropper.min.js"></script>
<script is:inline>
  // ===== å·¥å…·å‡½å¼ =====
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }

  function getSmartFormat(originalFile) {
    const type = originalFile.type.toLowerCase();
    if (type === 'image/jpeg' || type === 'image/jpg') return 'jpeg';
    return 'webp';
  }

  function getExtension(format) {
    return format === 'jpeg' ? 'jpg' : format;
  }

  function compressCanvas(canvas, format, quality) {
    return new Promise((resolve, reject) => {
      let targetCanvas = canvas;

      if (format === 'jpeg') {
        const newCanvas = document.createElement('canvas');
        const newCtx = newCanvas.getContext('2d');
        newCanvas.width = canvas.width;
        newCanvas.height = canvas.height;
        newCtx.fillStyle = '#FFFFFF';
        newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
        newCtx.drawImage(canvas, 0, 0);
        targetCanvas = newCanvas;
      }

      const mimeType = 'image/' + format;
      targetCanvas.toBlob(
        (blob) => blob ? resolve(blob) : reject(new Error('ç„¡æ³•å£“ç¸®åœ–ç‰‡')),
        mimeType,
        quality
      );
    });
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ===== DOM Elements =====
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const editorArea = document.getElementById('editorArea');
  const previewImage = document.getElementById('previewImage');
  const aspectBtns = document.querySelectorAll('.aspect-btn');
  const sizeModeRadios = document.querySelectorAll('input[name="sizeMode"]');
  const customWidthArea = document.getElementById('customWidthArea');
  const customWidth = document.getElementById('customWidth');
  const outputFormat = document.getElementById('outputFormat');
  const qualitySlider = document.getElementById('qualitySlider');
  const qualityValue = document.getElementById('qualityValue');
  const originalSize = document.getElementById('originalSize');
  const estimatedSize = document.getElementById('estimatedSize');
  const originalInfo = document.getElementById('originalInfo');
  const outputDimensions = document.getElementById('outputDimensions');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomResetBtn = document.getElementById('zoomResetBtn');

  // ===== State =====
  let cropper = null;
  let originalFile = null;
  let cropWidth = 0;
  let cropHeight = 0;

  // ===== Upload handlers =====
  uploadArea.addEventListener('click', () => fileInput.click());

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      handleFile(file);
    }
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  function handleFile(file) {
    originalFile = file;
    originalSize.textContent = formatFileSize(file.size);

    const url = URL.createObjectURL(file);
    const img = new Image();

    img.onload = function() {
      originalInfo.textContent = img.naturalWidth + ' Ã— ' + img.naturalHeight;

      previewImage.src = url;
      uploadArea.classList.add('hidden');
      editorArea.classList.remove('hidden');

      setTimeout(() => {
        if (cropper) cropper.destroy();

        cropper = new Cropper(previewImage, {
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          ready: function() {
            updateCropDimensions();
            updateEstimatedSize();
          },
          crop: function() {
            updateCropDimensions();
          }
        });
      }, 100);
    };

    img.onerror = function() {
      alert('ç„¡æ³•è®€å–åœ–ç‰‡ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
      URL.revokeObjectURL(url);
    };

    img.src = url;
  }

  // ===== Aspect ratio buttons =====
  aspectBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      aspectBtns.forEach(b => {
        b.classList.remove('active', 'bg-accent-blue', 'border-accent-blue', 'text-base-50');
        b.classList.add('border-base-600', 'text-base-400');
      });
      btn.classList.add('active', 'bg-accent-blue', 'border-accent-blue', 'text-base-50');
      btn.classList.remove('border-base-600', 'text-base-400');

      const aspect = btn.dataset.aspect;
      cropper.setAspectRatio(aspect === 'free' ? NaN : parseFloat(aspect));
    });
  });

  // ===== Zoom buttons =====
  zoomOutBtn.addEventListener('click', () => cropper && cropper.zoom(-0.1));
  zoomInBtn.addEventListener('click', () => cropper && cropper.zoom(0.1));
  zoomResetBtn.addEventListener('click', () => cropper && cropper.zoomTo(1));

  // ===== Size mode selection =====
  sizeModeRadios.forEach(function(radio) {
    radio.addEventListener('change', function() {
      customWidthArea.classList.toggle('hidden', this.value !== 'custom');
      updateEstimatedSize();
    });
  });

  customWidth.addEventListener('input', updateEstimatedSize);

  // ===== Quality slider =====
  qualitySlider.addEventListener('input', function() {
    qualityValue.textContent = qualitySlider.value + '%';
    updateEstimatedSize();
  });

  // ===== Format change =====
  outputFormat.addEventListener('change', updateEstimatedSize);

  // ===== Update crop dimensions =====
  function updateCropDimensions() {
    if (!cropper) return;
    const data = cropper.getData();
    cropWidth = Math.round(data.width);
    cropHeight = Math.round(data.height);
    updateOutputDimensionsDisplay();
  }

  // ===== Calculate output dimensions based on size mode =====
  function getOutputDimensions() {
    const sizeMode = document.querySelector('input[name="sizeMode"]:checked').value;

    switch (sizeMode) {
      case 'half':
        return {
          width: Math.round(cropWidth * 0.5),
          height: Math.round(cropHeight * 0.5)
        };
      case 'custom':
        const targetWidth = parseInt(customWidth.value) || cropWidth;
        const ratio = cropHeight / cropWidth;
        return {
          width: targetWidth,
          height: Math.round(targetWidth * ratio)
        };
      default: // original
        return { width: cropWidth, height: cropHeight };
    }
  }

  function updateOutputDimensionsDisplay() {
    const dims = getOutputDimensions();
    outputDimensions.textContent = dims.width + ' Ã— ' + dims.height + ' px';
  }

  // ===== Estimate output size =====
  let estimateTimeout = null;
  function updateEstimatedSize() {
    if (!cropper) return;

    updateOutputDimensionsDisplay();

    clearTimeout(estimateTimeout);
    estimateTimeout = setTimeout(async function() {
      try {
        const dims = getOutputDimensions();

        const canvas = cropper.getCroppedCanvas({
          width: dims.width,
          height: dims.height
        });

        if (!canvas) return;

        let format = outputFormat.value;
        if (format === 'auto') format = getSmartFormat(originalFile);

        const quality = parseInt(qualitySlider.value) / 100;
        const blob = await compressCanvas(canvas, format, quality);
        estimatedSize.textContent = formatFileSize(blob.size);

      } catch (error) {
        console.error('Error estimating size:', error);
      }
    }, 300);
  }

  // ===== Download =====
  downloadBtn.addEventListener('click', async function() {
    if (!cropper) return;

    downloadBtn.disabled = true;
    downloadBtn.textContent = 'â³ è™•ç†ä¸­...';

    try {
      const dims = getOutputDimensions();

      const canvas = cropper.getCroppedCanvas({
        width: dims.width,
        height: dims.height
      });

      let format = outputFormat.value;
      if (format === 'auto') format = getSmartFormat(originalFile);

      const quality = parseInt(qualitySlider.value) / 100;
      const blob = await compressCanvas(canvas, format, quality);

      const originalName = originalFile.name.replace(/\.[^/.]+$/, '');
      const extension = getExtension(format);
      downloadBlob(blob, originalName + '_processed.' + extension);

    } catch (error) {
      console.error('Error processing:', error);
      alert('è™•ç†åœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤');
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡';
    }
  });

  // ===== Reset =====
  resetBtn.addEventListener('click', function() {
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    originalFile = null;
    cropWidth = 0;
    cropHeight = 0;
    previewImage.src = '';
    fileInput.value = '';
    editorArea.classList.add('hidden');
    uploadArea.classList.remove('hidden');

    qualitySlider.value = 80;
    qualityValue.textContent = '80%';
    outputFormat.value = 'auto';
    originalSize.textContent = '-';
    estimatedSize.textContent = '-';
    originalInfo.textContent = '';
    outputDimensions.textContent = '-- Ã— -- px';
    customWidth.value = '800';
    customWidthArea.classList.add('hidden');

    aspectBtns.forEach((b, i) => {
      if (i === 0) {
        b.classList.add('active', 'bg-accent-blue', 'border-accent-blue', 'text-base-50');
        b.classList.remove('border-base-600', 'text-base-400');
      } else {
        b.classList.remove('active', 'bg-accent-blue', 'border-accent-blue', 'text-base-50');
        b.classList.add('border-base-600', 'text-base-400');
      }
    });

    sizeModeRadios.forEach(r => r.checked = r.value === 'original');
  });
</script>
