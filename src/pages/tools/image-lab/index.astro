---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout
  title="åœ–ç‰‡è™•ç†å·¥å»  | æŒ«å±å‹‡çš„å¯¦ç”¨å·¥å…·"
  description="ç·šä¸Šåœ–ç‰‡å£“ç¸®ã€è£åˆ‡ã€ç¸®æ”¾å·¥å…·ã€‚ç´”ç€è¦½å™¨è™•ç†ï¼Œä½ çš„ç…§ç‰‡ä¸æœƒè¢«ä¸Šå‚³åˆ°ä¼ºæœå™¨ï¼Œå®‰å¿ƒä½¿ç”¨ï¼"
>
  <Navbar currentPage="tools" />

  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="/libs/cropperjs/cropper.min.css">

  <div class="container mt-4">
    <h1 class="mb-3">ğŸ–¼ï¸ åœ–ç‰‡è™•ç†å·¥å» </h1>

    <!-- å®‰å…¨æç¤º -->
    <div class="alert alert-info border-0 shadow-sm mb-4">
      <h5 class="alert-heading fw-bold">ğŸ”’ ä½ çš„ç…§ç‰‡å¾ˆå®‰å…¨</h5>
      <p class="mb-0">
        æ‰€æœ‰è™•ç†éƒ½åœ¨ç€è¦½å™¨å®Œæˆï¼Œåœ–ç‰‡<strong>ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨</strong>ã€‚
      </p>
    </div>

    <!-- ä¸Šå‚³å€ -->
    <div id="uploadArea" class="upload-area mb-4">
      <div class="upload-content">
        <div class="upload-icon">ğŸ“</div>
        <p class="mb-2">æ‹–æ‹‰åœ–ç‰‡åˆ°é€™è£¡ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</p>
        <p class="text-muted small">æ”¯æ´ JPGã€PNGã€WebPã€GIF</p>
        <input type="file" id="fileInput" accept="image/*" class="d-none">
      </div>
    </div>

    <!-- ç·¨è¼¯å€ (é è¨­éš±è—) -->
    <div id="editorArea" class="d-none">
      <div class="row">
        <!-- å·¦å´ï¼šåœ–ç‰‡é è¦½ -->
        <div class="col-lg-8 mb-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span>ğŸ“· ç·¨è¼¯åœ–ç‰‡</span>
              <div class="d-flex align-items-center gap-2">
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" id="zoomOutBtn" class="btn btn-outline-light" title="ç¸®å°">â–</button>
                  <button type="button" id="zoomInBtn" class="btn btn-outline-light" title="æ”¾å¤§">â•</button>
                  <button type="button" id="zoomResetBtn" class="btn btn-outline-light" title="é‡è¨­">â†º</button>
                </div>
                <span id="originalInfo" class="badge bg-secondary"></span>
              </div>
            </div>
            <div class="card-body p-0">
              <div class="cropper-container-wrapper">
                <img id="previewImage" src="" alt="é è¦½">
              </div>
            </div>
            <div class="card-footer d-flex justify-content-between align-items-center">
              <small class="text-muted">ğŸ’¡ æ»‘é¼ æ»¾è¼ªç¸®æ”¾ï¼Œæ‹–æ‹‰é‚Šæ¡†èª¿æ•´è£åˆ‡</small>
              <span id="outputDimensions" class="badge bg-info">-- Ã— -- px</span>
            </div>
          </div>
        </div>

        <!-- å³å´ï¼šæ§åˆ¶é¢æ¿ -->
        <div class="col-lg-4">
          <!-- æ­¥é©Ÿ 1ï¼šè£åˆ‡æ¯”ä¾‹ -->
          <div class="card mb-3">
            <div class="card-header">
              <span class="step-badge">1</span> è£åˆ‡æ¯”ä¾‹
            </div>
            <div class="card-body">
              <div class="btn-group w-100" role="group">
                <button type="button" class="btn btn-outline-primary aspect-btn active" data-aspect="free">è‡ªç”±</button>
                <button type="button" class="btn btn-outline-primary aspect-btn" data-aspect="1">1:1</button>
                <button type="button" class="btn btn-outline-primary aspect-btn" data-aspect="1.778">16:9</button>
                <button type="button" class="btn btn-outline-primary aspect-btn" data-aspect="1.333">4:3</button>
              </div>
            </div>
          </div>

          <!-- æ­¥é©Ÿ 2ï¼šè¼¸å‡ºå¤§å° -->
          <div class="card mb-3">
            <div class="card-header">
              <span class="step-badge">2</span> è¼¸å‡ºå¤§å°
            </div>
            <div class="card-body">
              <div class="size-options">
                <label class="size-option">
                  <input type="radio" name="sizeMode" value="original" checked>
                  <span class="size-option-content">
                    <span class="size-option-label">åŸå§‹å¤§å°</span>
                    <span class="size-option-desc">ç¶­æŒè£åˆ‡å¾Œçš„å°ºå¯¸</span>
                  </span>
                </label>
                <label class="size-option">
                  <input type="radio" name="sizeMode" value="half">
                  <span class="size-option-content">
                    <span class="size-option-label">ç¸®å° 50%</span>
                    <span class="size-option-desc">é©åˆä¸€èˆ¬åˆ†äº«</span>
                  </span>
                </label>
                <label class="size-option">
                  <input type="radio" name="sizeMode" value="custom">
                  <span class="size-option-content">
                    <span class="size-option-label">æŒ‡å®šå¯¬åº¦</span>
                    <span class="size-option-desc">è‡ªå‹•è¨ˆç®—é«˜åº¦</span>
                  </span>
                </label>
              </div>
              <!-- è‡ªè¨‚å¯¬åº¦è¼¸å…¥ (é è¨­éš±è—) -->
              <div id="customWidthArea" class="mt-3 d-none">
                <div class="input-group input-group-sm">
                  <input type="number" id="customWidth" class="form-control" placeholder="800" value="800">
                  <span class="input-group-text">px</span>
                </div>
              </div>
            </div>
          </div>

          <!-- æ­¥é©Ÿ 3ï¼šè¼¸å‡ºæ ¼å¼ -->
          <div class="card mb-3">
            <div class="card-header">
              <span class="step-badge">3</span> æ ¼å¼èˆ‡å“è³ª
            </div>
            <div class="card-body">
              <div class="row g-2 mb-3">
                <div class="col-6">
                  <select id="outputFormat" class="form-select form-select-sm">
                    <option value="auto">è‡ªå‹•</option>
                    <option value="jpeg">JPG</option>
                    <option value="webp">WebP</option>
                    <option value="png">PNG</option>
                  </select>
                </div>
                <div class="col-6">
                  <div class="d-flex align-items-center h-100">
                    <input type="range" id="qualitySlider" class="form-range me-2" min="10" max="100" value="80" style="flex:1">
                    <span id="qualityValue" class="small text-nowrap">80%</span>
                  </div>
                </div>
              </div>
              <div class="file-size-info">
                <span>åŸå§‹: <strong id="originalSize">-</strong></span>
                <span class="mx-2">â†’</span>
                <span>é ä¼°: <strong id="estimatedSize" class="text-success">-</strong></span>
              </div>
            </div>
          </div>

          <!-- ä¸‹è¼‰æŒ‰éˆ• -->
          <button id="downloadBtn" class="btn btn-success w-100 btn-lg mb-2">
            â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡
          </button>

          <!-- é‡æ–°ä¸Šå‚³ -->
          <button id="resetBtn" class="btn btn-outline-secondary w-100">
            ğŸ”„ é‡æ–°é¸æ“‡åœ–ç‰‡
          </button>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<style>
  .upload-area {
    border: 3px dashed var(--bs-primary);
    border-radius: 1rem;
    padding: 3rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    background: rgba(var(--bs-primary-rgb), 0.05);
  }

  .upload-area:hover,
  .upload-area.dragover {
    background: rgba(var(--bs-primary-rgb), 0.15);
    border-color: var(--bs-success);
  }

  .upload-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .cropper-container-wrapper {
    max-height: 500px;
    overflow: hidden;
    background: #1a1a1a;
  }

  .cropper-container-wrapper img {
    display: block;
    max-width: 100%;
  }

  /* Step badge */
  .step-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 1.5rem;
    height: 1.5rem;
    border-radius: 50%;
    background: var(--bs-primary);
    color: white;
    font-size: 0.8rem;
    font-weight: bold;
    margin-right: 0.5rem;
  }

  /* Aspect buttons */
  .aspect-btn.active {
    background-color: var(--bs-primary);
    color: white;
  }

  /* Size options - radio card style */
  .size-options {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .size-option {
    display: block;
    cursor: pointer;
    margin: 0;
  }

  .size-option input {
    display: none;
  }

  .size-option-content {
    display: flex;
    flex-direction: column;
    padding: 0.75rem;
    border: 2px solid var(--bs-border-color);
    border-radius: 0.5rem;
    transition: all 0.2s ease;
  }

  .size-option input:checked + .size-option-content {
    border-color: var(--bs-primary);
    background: rgba(var(--bs-primary-rgb), 0.1);
  }

  .size-option-content:hover {
    border-color: var(--bs-primary);
  }

  .size-option-label {
    font-weight: 500;
  }

  .size-option-desc {
    font-size: 0.75rem;
    color: var(--bs-secondary);
  }

  /* File size info */
  .file-size-info {
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 0.85rem;
    padding: 0.5rem;
    background: rgba(0,0,0,0.2);
    border-radius: 0.25rem;
  }
</style>

<script is:inline src="/libs/cropperjs/cropper.min.js"></script>
<script is:inline>
  // ===== å·¥å…·å‡½å¼ =====
  function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
  }

  function getSmartFormat(originalFile) {
    const type = originalFile.type.toLowerCase();
    if (type === 'image/jpeg' || type === 'image/jpg') return 'jpeg';
    return 'webp';
  }

  function getExtension(format) {
    return format === 'jpeg' ? 'jpg' : format;
  }

  function compressCanvas(canvas, format, quality) {
    return new Promise((resolve, reject) => {
      let targetCanvas = canvas;

      if (format === 'jpeg') {
        const newCanvas = document.createElement('canvas');
        const newCtx = newCanvas.getContext('2d');
        newCanvas.width = canvas.width;
        newCanvas.height = canvas.height;
        newCtx.fillStyle = '#FFFFFF';
        newCtx.fillRect(0, 0, newCanvas.width, newCanvas.height);
        newCtx.drawImage(canvas, 0, 0);
        targetCanvas = newCanvas;
      }

      const mimeType = 'image/' + format;
      targetCanvas.toBlob(
        (blob) => blob ? resolve(blob) : reject(new Error('ç„¡æ³•å£“ç¸®åœ–ç‰‡')),
        mimeType,
        quality
      );
    });
  }

  function downloadBlob(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ===== DOM Elements =====
  const uploadArea = document.getElementById('uploadArea');
  const fileInput = document.getElementById('fileInput');
  const editorArea = document.getElementById('editorArea');
  const previewImage = document.getElementById('previewImage');
  const aspectBtns = document.querySelectorAll('.aspect-btn');
  const sizeModeRadios = document.querySelectorAll('input[name="sizeMode"]');
  const customWidthArea = document.getElementById('customWidthArea');
  const customWidth = document.getElementById('customWidth');
  const outputFormat = document.getElementById('outputFormat');
  const qualitySlider = document.getElementById('qualitySlider');
  const qualityValue = document.getElementById('qualityValue');
  const originalSize = document.getElementById('originalSize');
  const estimatedSize = document.getElementById('estimatedSize');
  const originalInfo = document.getElementById('originalInfo');
  const outputDimensions = document.getElementById('outputDimensions');
  const downloadBtn = document.getElementById('downloadBtn');
  const resetBtn = document.getElementById('resetBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomResetBtn = document.getElementById('zoomResetBtn');

  // ===== State =====
  let cropper = null;
  let originalFile = null;
  let cropWidth = 0;
  let cropHeight = 0;

  // ===== Upload handlers =====
  uploadArea.addEventListener('click', () => fileInput.click());

  uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
  });

  uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
  });

  uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');
    const file = e.dataTransfer.files[0];
    if (file && file.type.startsWith('image/')) {
      handleFile(file);
    }
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (file) handleFile(file);
  });

  function handleFile(file) {
    originalFile = file;
    originalSize.textContent = formatFileSize(file.size);

    const url = URL.createObjectURL(file);
    const img = new Image();

    img.onload = function() {
      originalInfo.textContent = img.naturalWidth + ' Ã— ' + img.naturalHeight;

      previewImage.src = url;
      uploadArea.classList.add('d-none');
      editorArea.classList.remove('d-none');

      setTimeout(() => {
        if (cropper) cropper.destroy();

        cropper = new Cropper(previewImage, {
          viewMode: 1,
          dragMode: 'move',
          autoCropArea: 1,
          restore: false,
          guides: true,
          center: true,
          highlight: false,
          cropBoxMovable: true,
          cropBoxResizable: true,
          toggleDragModeOnDblclick: false,
          ready: function() {
            updateCropDimensions();
            updateEstimatedSize();
          },
          crop: function() {
            updateCropDimensions();
          }
        });
      }, 100);
    };

    img.onerror = function() {
      alert('ç„¡æ³•è®€å–åœ–ç‰‡ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼æ­£ç¢ºã€‚');
      URL.revokeObjectURL(url);
    };

    img.src = url;
  }

  // ===== Aspect ratio buttons =====
  aspectBtns.forEach(function(btn) {
    btn.addEventListener('click', function() {
      aspectBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const aspect = btn.dataset.aspect;
      cropper.setAspectRatio(aspect === 'free' ? NaN : parseFloat(aspect));
    });
  });

  // ===== Zoom buttons =====
  zoomOutBtn.addEventListener('click', () => cropper && cropper.zoom(-0.1));
  zoomInBtn.addEventListener('click', () => cropper && cropper.zoom(0.1));
  zoomResetBtn.addEventListener('click', () => cropper && cropper.zoomTo(1));

  // ===== Size mode selection =====
  sizeModeRadios.forEach(function(radio) {
    radio.addEventListener('change', function() {
      customWidthArea.classList.toggle('d-none', this.value !== 'custom');
      updateEstimatedSize();
    });
  });

  customWidth.addEventListener('input', updateEstimatedSize);

  // ===== Quality slider =====
  qualitySlider.addEventListener('input', function() {
    qualityValue.textContent = qualitySlider.value + '%';
    updateEstimatedSize();
  });

  // ===== Format change =====
  outputFormat.addEventListener('change', updateEstimatedSize);

  // ===== Update crop dimensions =====
  function updateCropDimensions() {
    if (!cropper) return;
    const data = cropper.getData();
    cropWidth = Math.round(data.width);
    cropHeight = Math.round(data.height);
    updateOutputDimensionsDisplay();
  }

  // ===== Calculate output dimensions based on size mode =====
  function getOutputDimensions() {
    const sizeMode = document.querySelector('input[name="sizeMode"]:checked').value;

    switch (sizeMode) {
      case 'half':
        return {
          width: Math.round(cropWidth * 0.5),
          height: Math.round(cropHeight * 0.5)
        };
      case 'custom':
        const targetWidth = parseInt(customWidth.value) || cropWidth;
        const ratio = cropHeight / cropWidth;
        return {
          width: targetWidth,
          height: Math.round(targetWidth * ratio)
        };
      default: // original
        return { width: cropWidth, height: cropHeight };
    }
  }

  function updateOutputDimensionsDisplay() {
    const dims = getOutputDimensions();
    outputDimensions.textContent = dims.width + ' Ã— ' + dims.height + ' px';
  }

  // ===== Estimate output size =====
  let estimateTimeout = null;
  function updateEstimatedSize() {
    if (!cropper) return;

    updateOutputDimensionsDisplay();

    clearTimeout(estimateTimeout);
    estimateTimeout = setTimeout(async function() {
      try {
        const dims = getOutputDimensions();

        const canvas = cropper.getCroppedCanvas({
          width: dims.width,
          height: dims.height
        });

        if (!canvas) return;

        let format = outputFormat.value;
        if (format === 'auto') format = getSmartFormat(originalFile);

        const quality = parseInt(qualitySlider.value) / 100;
        const blob = await compressCanvas(canvas, format, quality);
        estimatedSize.textContent = formatFileSize(blob.size);

      } catch (error) {
        console.error('Error estimating size:', error);
      }
    }, 300);
  }

  // ===== Download =====
  downloadBtn.addEventListener('click', async function() {
    if (!cropper) return;

    downloadBtn.disabled = true;
    downloadBtn.textContent = 'â³ è™•ç†ä¸­...';

    try {
      const dims = getOutputDimensions();

      const canvas = cropper.getCroppedCanvas({
        width: dims.width,
        height: dims.height
      });

      let format = outputFormat.value;
      if (format === 'auto') format = getSmartFormat(originalFile);

      const quality = parseInt(qualitySlider.value) / 100;
      const blob = await compressCanvas(canvas, format, quality);

      const originalName = originalFile.name.replace(/\.[^/.]+$/, '');
      const extension = getExtension(format);
      downloadBlob(blob, originalName + '_processed.' + extension);

    } catch (error) {
      console.error('Error processing:', error);
      alert('è™•ç†åœ–ç‰‡æ™‚ç™¼ç”ŸéŒ¯èª¤');
    } finally {
      downloadBtn.disabled = false;
      downloadBtn.textContent = 'â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡';
    }
  });

  // ===== Reset =====
  resetBtn.addEventListener('click', function() {
    if (cropper) {
      cropper.destroy();
      cropper = null;
    }
    originalFile = null;
    cropWidth = 0;
    cropHeight = 0;
    previewImage.src = '';
    fileInput.value = '';
    editorArea.classList.add('d-none');
    uploadArea.classList.remove('d-none');

    qualitySlider.value = 80;
    qualityValue.textContent = '80%';
    outputFormat.value = 'auto';
    originalSize.textContent = '-';
    estimatedSize.textContent = '-';
    originalInfo.textContent = '';
    outputDimensions.textContent = '-- Ã— -- px';
    customWidth.value = '800';
    customWidthArea.classList.add('d-none');

    aspectBtns.forEach(b => b.classList.remove('active'));
    aspectBtns[0].classList.add('active');

    sizeModeRadios.forEach(r => r.checked = r.value === 'original');
  });
</script>
