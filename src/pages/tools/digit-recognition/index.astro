---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout
  title="æ‰‹å¯«æ•¸å­—è¾¨è­˜ | æŒ«å±å‹‡çš„å¯¦ç”¨å·¥å…·"
  description="åœ¨ç•«å¸ƒä¸Šæ‰‹å¯«æ•¸å­—ï¼ŒAI å³æ™‚è¾¨è­˜ï¼ä½¿ç”¨ TensorFlow.js åœ¨ç€è¦½å™¨ç«¯é‹è¡Œæ·±åº¦å­¸ç¿’æ¨¡å‹ï¼Œæ”¯æ´æ‰‹æ©Ÿèˆ‡é›»è…¦ã€‚"
>
  <Navbar currentPage="tools" />

  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <h1 class="text-3xl font-bold text-base-50 mb-4">âœï¸ æ‰‹å¯«æ•¸å­—è¾¨è­˜</h1>

    <!-- åŠŸèƒ½èªªæ˜ -->
    <div class="bg-accent-cyan/20 border border-accent-cyan rounded-lg p-4 mb-6">
      <h5 class="font-bold text-accent-cyan mb-1">ğŸ§  AI åœ¨ä½ çš„ç€è¦½å™¨è£¡é‹è¡Œ</h5>
      <p class="text-base-400">
        ä½¿ç”¨æ·±åº¦å­¸ç¿’æ¨¡å‹è¾¨è­˜æ‰‹å¯«æ•¸å­—ï¼Œ<strong class="text-base-50">ä¸éœ€è¦ç¶²è·¯é€£ç·š</strong>ï¼Œæ‰€æœ‰é‹ç®—éƒ½åœ¨æœ¬åœ°å®Œæˆã€‚
      </p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- å·¦å´ï¼šç•«å¸ƒå€åŸŸ -->
      <div class="space-y-4">
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center justify-between">
            <span class="flex items-center">
              <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-blue text-base-50 text-sm font-bold mr-2">1</span>
              åœ¨ä¸‹æ–¹ç•«ä¸€å€‹æ•¸å­— (0-9)
            </span>
            <button id="clearBtn" class="px-3 py-1 rounded border border-base-600 text-base-400 hover:bg-base-600 text-sm transition">æ¸…é™¤</button>
          </div>
          <div class="p-4 text-center">
            <div class="inline-block border-2 border-accent-blue rounded-lg overflow-hidden" style="touch-action: none;">
              <canvas id="drawCanvas" width="280" height="280" class="block bg-base-900 cursor-crosshair"></canvas>
            </div>
            <p class="text-base-600 text-sm mt-2">ç”¨æ»‘é¼ æˆ–æ‰‹æŒ‡åœ¨ç•«å¸ƒä¸Šæ›¸å¯«</p>
          </div>
        </div>

        <!-- é è™•ç†é è¦½ -->
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-blue text-base-50 text-sm font-bold mr-2">2</span>
            æ¨¡å‹è¦–è§’
          </div>
          <div class="p-4">
            <div class="flex justify-center gap-6 flex-wrap">
              <div class="text-center">
                <canvas id="previewCanvas" width="140" height="140" class="border border-base-600 rounded bg-black" style="image-rendering: pixelated;"></canvas>
                <p class="text-base-600 text-sm mt-2">è¼¸å…¥åœ–ç‰‡ (28Ã—28)</p>
              </div>
              <div class="text-center">
                <canvas id="saliencyCanvas" width="140" height="140" class="border border-base-600 rounded bg-black" style="image-rendering: pixelated;"></canvas>
                <p class="text-base-600 text-sm mt-2">Saliency Map</p>
              </div>
            </div>
            <p class="text-base-600 text-sm mt-3 text-center">
              <span class="inline-block px-2 py-0.5 rounded text-xs font-bold bg-accent-red/30 text-accent-red">ç´…</span> = é«˜å½±éŸ¿ &nbsp;
              <span class="inline-block px-2 py-0.5 rounded text-xs font-bold bg-accent-blue/30 text-accent-blue">è—</span> = ä½å½±éŸ¿
            </p>
          </div>
        </div>
      </div>

      <!-- å³å´ï¼šé æ¸¬çµæœ -->
      <div>
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden h-full">
          <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center">
            <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-blue text-base-50 text-sm font-bold mr-2">3</span>
            é æ¸¬çµæœ
          </div>
          <div class="p-4">
            <!-- æ¨¡å‹è¼‰å…¥ç‹€æ…‹ -->
            <div id="modelStatus" class="text-center py-8">
              <div class="inline-block w-8 h-8 border-4 border-accent-blue border-t-transparent rounded-full animate-spin mb-3"></div>
              <p class="text-base-600">æ­£åœ¨è¼‰å…¥æ¨¡å‹...</p>
            </div>

            <!-- é æ¸¬æ•¸å­— -->
            <div id="predictionResult" class="hidden">
              <div class="text-center mb-6">
                <div id="predictedDigit" class="text-7xl font-bold text-accent-blue" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">?</div>
                <p class="text-base-600">é æ¸¬æ•¸å­—</p>
              </div>

              <!-- æ©Ÿç‡é•·æ¢åœ– -->
              <div id="probabilityChart" class="space-y-2">
                <!-- å‹•æ…‹ç”Ÿæˆ -->
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- æŠ€è¡“èªªæ˜ -->
    <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden mt-6 mb-8">
      <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center justify-between">
        <span class="flex items-center">
          <span class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-accent-blue text-base-50 text-sm font-bold mr-2">?</span>
          é€™æ˜¯æ€éº¼é‹ä½œçš„ï¼Ÿ
        </span>
        <a href="/blog/mnist-browser-ml/" class="px-3 py-1 rounded border border-accent-blue text-accent-blue hover:bg-accent-blue/10 text-sm transition">é–±è®€é–‹ç™¼ç­†è¨˜</a>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div>
            <h6 class="font-bold text-base-50 mb-1">æ¨¡å‹æ¶æ§‹</h6>
            <p class="text-sm text-base-600">
              è¼•é‡ç´š CNNï¼Œ2 å±¤å·ç© + 1 å±¤å…¨é€£æ¥ï¼ŒMNIST æº–ç¢ºåº¦ 98.77%ã€‚
            </p>
          </div>
          <div>
            <h6 class="font-bold text-base-50 mb-1">å‰ç«¯æ¨ç†</h6>
            <p class="text-sm text-base-600">
              TensorFlow.js è¼‰å…¥æ¨¡å‹ï¼Œç€è¦½å™¨ç«¯é‹ç®—ï¼Œç´„ 420KBã€‚
            </p>
          </div>
          <div>
            <h6 class="font-bold text-base-50 mb-1">åœ–ç‰‡é è™•ç†</h6>
            <p class="text-sm text-base-600">
              ç­†è·¡ç½®ä¸­ã€ç¸®æ”¾ 28Ã—28ã€æ­£è¦åŒ–ç‚ºé»‘åº•ç™½å­—ã€‚
            </p>
          </div>
          <div>
            <h6 class="font-bold text-base-50 mb-1">Saliency Map</h6>
            <p class="text-sm text-base-600">
              è¨ˆç®—è¼¸å…¥æ¢¯åº¦ï¼Œé¡¯ç¤ºå“ªäº›åƒç´ å°é æ¸¬å½±éŸ¿æœ€å¤§ã€‚
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
<script is:inline>
document.addEventListener('DOMContentLoaded', async function() {
  // ===== DOM Elements =====
  const drawCanvas = document.getElementById('drawCanvas');
  const drawCtx = drawCanvas.getContext('2d');
  const previewCanvas = document.getElementById('previewCanvas');
  const previewCtx = previewCanvas.getContext('2d');
  const saliencyCanvas = document.getElementById('saliencyCanvas');
  const saliencyCtx = saliencyCanvas.getContext('2d');
  const clearBtn = document.getElementById('clearBtn');
  const modelStatus = document.getElementById('modelStatus');
  const predictionResult = document.getElementById('predictionResult');
  const predictedDigit = document.getElementById('predictedDigit');
  const probabilityChart = document.getElementById('probabilityChart');

  // ===== State =====
  let isDrawing = false;
  let model = null;
  let lastX = 0;
  let lastY = 0;

  // ===== Initialize Canvas =====
  function initCanvas() {
    drawCtx.fillStyle = '#002b36';
    drawCtx.fillRect(0, 0, drawCanvas.width, drawCanvas.height);
    drawCtx.strokeStyle = '#ffffff';
    drawCtx.lineWidth = 15;
    drawCtx.lineCap = 'round';
    drawCtx.lineJoin = 'round';
  }
  initCanvas();

  // ===== Load Model =====
  try {
    model = await tf.loadLayersModel('/models/mnist/model.json');
    modelStatus.classList.add('hidden');
    predictionResult.classList.remove('hidden');
    initProbabilityChart();
    console.log('Model loaded successfully');
  } catch (error) {
    console.error('Failed to load model:', error);
    modelStatus.innerHTML = `
      <p class="text-accent-red">æ¨¡å‹è¼‰å…¥å¤±æ•—</p>
      <p class="text-base-600 text-sm mt-2">${error.message}</p>
    `;
  }

  // ===== Drawing Functions =====
  function getPosition(e) {
    const rect = drawCanvas.getBoundingClientRect();
    const scaleX = drawCanvas.width / rect.width;
    const scaleY = drawCanvas.height / rect.height;

    if (e.touches) {
      return {
        x: (e.touches[0].clientX - rect.left) * scaleX,
        y: (e.touches[0].clientY - rect.top) * scaleY
      };
    }
    return {
      x: (e.clientX - rect.left) * scaleX,
      y: (e.clientY - rect.top) * scaleY
    };
  }

  function startDrawing(e) {
    e.preventDefault();
    isDrawing = true;
    const pos = getPosition(e);
    lastX = pos.x;
    lastY = pos.y;
  }

  function draw(e) {
    if (!isDrawing) return;
    e.preventDefault();

    const pos = getPosition(e);
    drawCtx.beginPath();
    drawCtx.moveTo(lastX, lastY);
    drawCtx.lineTo(pos.x, pos.y);
    drawCtx.stroke();

    lastX = pos.x;
    lastY = pos.y;
  }

  function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;
    predict();
  }

  // Mouse events
  drawCanvas.addEventListener('mousedown', startDrawing);
  drawCanvas.addEventListener('mousemove', draw);
  drawCanvas.addEventListener('mouseup', stopDrawing);
  drawCanvas.addEventListener('mouseleave', stopDrawing);

  // Touch events
  drawCanvas.addEventListener('touchstart', startDrawing, { passive: false });
  drawCanvas.addEventListener('touchmove', draw, { passive: false });
  drawCanvas.addEventListener('touchend', stopDrawing);

  // Clear button
  clearBtn.addEventListener('click', () => {
    initCanvas();
    clearPreview();
    resetPrediction();
  });

  // ===== Preview & Preprocessing =====
  function clearPreview() {
    previewCtx.fillStyle = '#000';
    previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
    saliencyCtx.fillStyle = '#000';
    saliencyCtx.fillRect(0, 0, saliencyCanvas.width, saliencyCanvas.height);
  }
  clearPreview();

  function preprocessImage() {
    const imageData = drawCtx.getImageData(0, 0, drawCanvas.width, drawCanvas.height);
    const data = imageData.data;

    let minX = drawCanvas.width, minY = drawCanvas.height, maxX = 0, maxY = 0;
    let hasContent = false;

    for (let y = 0; y < drawCanvas.height; y++) {
      for (let x = 0; x < drawCanvas.width; x++) {
        const idx = (y * drawCanvas.width + x) * 4;
        if (data[idx] > 200) {
          hasContent = true;
          if (x < minX) minX = x;
          if (x > maxX) maxX = x;
          if (y < minY) minY = y;
          if (y > maxY) maxY = y;
        }
      }
    }

    if (!hasContent) return null;

    const padding = 20;
    minX = Math.max(0, minX - padding);
    minY = Math.max(0, minY - padding);
    maxX = Math.min(drawCanvas.width, maxX + padding);
    maxY = Math.min(drawCanvas.height, maxY + padding);

    const bboxWidth = maxX - minX;
    const bboxHeight = maxY - minY;
    const size = Math.max(bboxWidth, bboxHeight);

    const offsetX = minX - (size - bboxWidth) / 2;
    const offsetY = minY - (size - bboxHeight) / 2;

    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = 28;
    tempCanvas.height = 28;
    const tempCtx = tempCanvas.getContext('2d');

    tempCtx.fillStyle = '#000';
    tempCtx.fillRect(0, 0, 28, 28);

    const scale = 20 / size;
    tempCtx.drawImage(
      drawCanvas,
      offsetX, offsetY, size, size,
      4, 4, 20, 20
    );

    previewCtx.imageSmoothingEnabled = false;
    previewCtx.drawImage(tempCanvas, 0, 0, 140, 140);

    const smallImageData = tempCtx.getImageData(0, 0, 28, 28);
    const pixels = new Float32Array(28 * 28);

    for (let i = 0; i < 28 * 28; i++) {
      pixels[i] = smallImageData.data[i * 4] / 255.0;
    }

    return pixels;
  }

  // ===== Prediction =====
  function initProbabilityChart() {
    let html = '';
    for (let i = 0; i < 10; i++) {
      html += `
        <div class="flex items-center gap-2">
          <span class="w-6 text-center font-bold text-base-400">${i}</span>
          <div class="flex-1 h-5 bg-base-600/30 rounded overflow-hidden">
            <div class="prob-bar h-full bg-accent-blue rounded transition-all duration-300" id="bar-${i}" style="width: 0%"></div>
          </div>
          <span class="w-14 text-right text-sm font-mono text-base-400" id="prob-${i}">0.0%</span>
        </div>
      `;
    }
    probabilityChart.innerHTML = html;
  }

  function resetPrediction() {
    predictedDigit.textContent = '?';
    for (let i = 0; i < 10; i++) {
      const bar = document.getElementById(`bar-${i}`);
      const prob = document.getElementById(`prob-${i}`);
      bar.style.width = '0%';
      bar.classList.remove('bg-accent-green');
      bar.classList.add('bg-accent-blue');
      prob.textContent = '0.0%';
    }
  }

  // ===== Saliency Map =====
  function renderSaliencyMap(gradients) {
    const absGradients = gradients.map(Math.abs);
    const maxGrad = Math.max(...absGradients);

    if (maxGrad === 0) return;

    const imageData = saliencyCtx.createImageData(28, 28);

    for (let i = 0; i < 28 * 28; i++) {
      const normalized = absGradients[i] / maxGrad;

      let r, g, b;
      if (normalized < 0.5) {
        const t = normalized * 2;
        r = Math.floor(t * 255);
        g = Math.floor(t * 255);
        b = 255;
      } else {
        const t = (normalized - 0.5) * 2;
        r = 255;
        g = Math.floor((1 - t) * 255);
        b = Math.floor((1 - t) * 255);
      }

      imageData.data[i * 4] = r;
      imageData.data[i * 4 + 1] = g;
      imageData.data[i * 4 + 2] = b;
      imageData.data[i * 4 + 3] = 255;
    }

    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = 28;
    tempCanvas.height = 28;
    const tempCtx = tempCanvas.getContext('2d');
    tempCtx.putImageData(imageData, 0, 0);

    saliencyCtx.imageSmoothingEnabled = false;
    saliencyCtx.drawImage(tempCanvas, 0, 0, 140, 140);
  }

  async function predict() {
    if (!model) return;

    const pixels = preprocessImage();
    if (!pixels) {
      resetPrediction();
      return;
    }

    const input = tf.tensor4d(pixels, [1, 28, 28, 1]);
    const prediction = model.predict(input);
    const probabilities = await prediction.data();

    let maxProb = 0;
    let maxIdx = 0;
    for (let i = 0; i < 10; i++) {
      if (probabilities[i] > maxProb) {
        maxProb = probabilities[i];
        maxIdx = i;
      }
    }

    const gradientFunc = tf.grad(x => {
      const pred = model.predict(x);
      return pred.gather([maxIdx], 1).squeeze();
    });

    const gradients = gradientFunc(input);
    const gradData = await gradients.data();

    renderSaliencyMap(Array.from(gradData));

    input.dispose();
    prediction.dispose();
    gradients.dispose();

    predictedDigit.textContent = maxIdx;

    for (let i = 0; i < 10; i++) {
      const bar = document.getElementById(`bar-${i}`);
      const prob = document.getElementById(`prob-${i}`);
      const percentage = probabilities[i] * 100;

      bar.style.width = `${percentage}%`;
      prob.textContent = `${percentage.toFixed(1)}%`;

      if (i === maxIdx) {
        bar.classList.remove('bg-accent-blue');
        bar.classList.add('bg-accent-green');
      } else {
        bar.classList.remove('bg-accent-green');
        bar.classList.add('bg-accent-blue');
      }
    }
  }
});
</script>
