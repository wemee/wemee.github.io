---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout title="質因數分解">
  <Navbar currentPage="math" />
  <div class="container mt-5">
    <h1 class="text-center">質因數分解</h1>
    <div class="mb-3">
      <label for="numberInput" class="form-label">輸入數字</label>
      <input type="number" class="form-control" id="numberInput" placeholder="輸入一個整數">
    </div>
    <button class="btn btn-primary" id="calculateBtn">分解</button>
    <p class="mt-3" id="timer">經過時間: 0 秒</p>
    <p class="mt-3" id="result"></p>
  </div>
</BaseLayout>

<script>
  let stopCalculation = false;

  function primeFactorization(num: number) {
    const factors: number[] = [];
    let divisor = 2;
    const startTime = Date.now();
    const resultEl = document.getElementById('result')!;
    const timerEl = document.getElementById('timer')!;
    const container = document.querySelector('.container')!;

    function updateTimer() {
      const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
      timerEl.innerText = `經過時間: ${elapsedTime} 秒`;

      if (parseFloat(elapsedTime) > 10 && !document.getElementById('stopButton')) {
        const stopButton = document.createElement('button');
        stopButton.id = 'stopButton';
        stopButton.className = 'btn btn-danger mt-3';
        stopButton.innerText = '停止';
        stopButton.onclick = () => { stopCalculation = true; };
        container.appendChild(stopButton);
      }
    }

    function checkTimeAndContinue() {
      updateTimer();

      if (stopCalculation) {
        resultEl.innerText = `目前找到的質因數: ${factors.join(', ')}。運算已停止。`;
        return;
      }

      findFactors();
    }

    function findFactors() {
      while (num % divisor === 0) {
        factors.push(divisor);
        num /= divisor;
        resultEl.innerText = `質因數: ${factors.join(', ')}`;
      }
      divisor++;

      if (divisor <= Math.sqrt(num)) {
        setTimeout(checkTimeAndContinue, 0);
      } else {
        if (num > 2) {
          factors.push(num);
          resultEl.innerText = `質因數: ${factors.join(', ')}`;
        }
      }
    }

    findFactors();
  }

  function displayFactors() {
    stopCalculation = false;
    const stopButton = document.getElementById('stopButton');
    if (stopButton) stopButton.remove();

    const input = (document.getElementById('numberInput') as HTMLInputElement).value;
    const num = parseInt(input);
    if (!isNaN(num) && num > 1) {
      primeFactorization(num);
    } else {
      document.getElementById('result')!.innerText = '請輸入大於1的整數';
    }
  }

  document.getElementById('calculateBtn')?.addEventListener('click', displayFactors);
</script>
