---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---

<BaseLayout
  title="交通流體力學模擬 | 幽靈塞車與交通波吸收視覺化"
  description="為什麼高速公路會無故塞車？互動式模擬讓你親眼看見「幽靈塞車」如何產生，以及佛系駕駛的「交通波吸收」策略如何改善車流。使用 IDM 智慧駕駛模型，可調整車輛比例與擾動參數。"
>
  <Navbar currentPage="math" />

  <div class="container-fluid mt-4 px-4">
    <!-- 標題 -->
    <div class="row mb-4">
      <div class="col-12 text-center">
        <h1 class="display-5">交通流體力學模擬</h1>
        <p class="lead text-muted">
          觀察「幽靈塞車」如何在無明確原因下產生與傳播
        </p>
      </div>
    </div>

    <div class="row">
      <!-- 左側：Canvas -->
      <div class="col-lg-8 mb-4">
        <div class="card shadow border-0" style="background: #0a0a1a;">
          <div class="card-body p-3 position-relative">
            <canvas id="trafficCanvas" style="width: 100%; height: 450px; display: block;"></canvas>

            <!-- 圖例 -->
            <div class="position-absolute top-0 end-0 p-3">
              <span class="badge me-1" style="background: #2ecc71;">正常車</span>
              <span class="badge me-1" style="background: #e74c3c;">擾動者</span>
              <span class="badge" style="background: #3498db;">吸收者</span>
            </div>
          </div>
        </div>

        <!-- 速度歷史圖表 -->
        <div class="card mt-3 border-secondary">
          <div class="card-header bg-transparent py-2">
            <small>平均速度歷史</small>
          </div>
          <div class="card-body p-2" style="background: #1a1a2e;">
            <canvas id="historyChart" style="width: 100%; height: 80px; display: block;"></canvas>
          </div>
        </div>
      </div>

      <!-- 右側：控制面板 -->
      <div class="col-lg-4">
        <!-- 播放控制 -->
        <div class="card mb-3 border-secondary">
          <div class="card-header bg-transparent py-2">
            控制
          </div>
          <div class="card-body">
            <div class="btn-group w-100 mb-3">
              <button class="btn btn-success" id="playBtn">
                <i class="bi bi-play-fill"></i> 播放
              </button>
              <button class="btn btn-warning" id="pauseBtn" disabled>
                <i class="bi bi-pause-fill"></i> 暫停
              </button>
              <button class="btn btn-secondary" id="resetBtn">
                <i class="bi bi-arrow-counterclockwise"></i> 重置
              </button>
            </div>

            <label class="form-label small">播放速度</label>
            <div class="btn-group w-100" id="speedBtnGroup">
              <button class="btn btn-outline-primary btn-sm" data-speed="0.5">0.5x</button>
              <button class="btn btn-outline-primary btn-sm active" data-speed="1">1x</button>
              <button class="btn btn-outline-primary btn-sm" data-speed="2">2x</button>
            </div>
          </div>
        </div>

        <!-- 車輛設定 -->
        <div class="card mb-3 border-secondary">
          <div class="card-header bg-transparent py-2">
            車輛設定
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label small d-flex justify-content-between">
                <span>總車輛數</span>
                <span id="totalVehiclesValue">30</span>
              </label>
              <input type="range" class="form-range" id="totalVehicles"
                     min="10" max="50" value="30">
            </div>

            <div class="mb-3">
              <label class="form-label small d-flex justify-content-between">
                <span style="color: #2ecc71;">正常車</span>
                <span id="normalRatioValue">60%</span>
              </label>
              <input type="range" class="form-range" id="normalRatio"
                     min="0" max="100" value="60">
            </div>

            <div class="mb-3">
              <label class="form-label small d-flex justify-content-between">
                <span style="color: #e74c3c;">擾動者</span>
                <span id="disruptorRatioValue">20%</span>
              </label>
              <input type="range" class="form-range" id="disruptorRatio"
                     min="0" max="100" value="20">
            </div>

            <div class="mb-0">
              <label class="form-label small d-flex justify-content-between">
                <span style="color: #3498db;">吸收者</span>
                <span id="absorberRatioValue">20%</span>
              </label>
              <input type="range" class="form-range" id="absorberRatio"
                     min="0" max="100" value="20">
            </div>
          </div>
        </div>

        <!-- 擾動參數 -->
        <div class="card border-secondary">
          <div class="card-header bg-transparent py-2">
            擾動參數
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label class="form-label small d-flex justify-content-between">
                <span>擾動頻率</span>
                <span id="disruptionFreqValue">0.5 次/秒</span>
              </label>
              <input type="range" class="form-range" id="disruptionFreq"
                     min="0.1" max="2" step="0.1" value="0.5">
            </div>

            <div class="mb-0">
              <label class="form-label small d-flex justify-content-between">
                <span>擾動強度</span>
                <span id="disruptionStrengthValue">50%</span>
              </label>
              <input type="range" class="form-range" id="disruptionStrength"
                     min="10" max="100" value="50">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 統計區 -->
    <div class="row mt-4">
      <div class="col-md-4 mb-3">
        <div class="card text-center border-primary h-100">
          <div class="card-body py-3">
            <h6 class="text-muted small mb-1">平均速度</h6>
            <h3 class="mb-0" id="avgVelocity">--</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card text-center border-warning h-100">
          <div class="card-body py-3">
            <h6 class="text-muted small mb-1">速度波動 (標準差)</h6>
            <h3 class="mb-0" id="velocityStdDev">--</h3>
          </div>
        </div>
      </div>
      <div class="col-md-4 mb-3">
        <div class="card text-center border-success h-100">
          <div class="card-body py-3">
            <h6 class="text-muted small mb-1">模擬時間</h6>
            <h3 class="mb-0" id="simTime">0:00</h3>
          </div>
        </div>
      </div>
    </div>

    <!-- 創作緣起 -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: rgba(39, 174, 96, 0.15);">
          <div class="card-body">
            <h4 class="mb-3">創作緣起</h4>
            <p class="mb-0" style="line-height: 1.8;">
              在高速公路開車時，我常常在想：<strong>我能不能保持車速穩定？</strong><br><br>
              譬如前車減速了，但我其實不必急著跟著煞車——因為在我逼近到危險距離之前，他可能就已經加速離開了。<br>
              又譬如塞車時，前車起步衝刺，但我也不必猛踩油門追上去——反正他待會又會因為前方壅塞而停下來。<br><br>
              這種「不急著反應」的駕駛方式，其實就是交通工程中所謂的<strong>「交通波吸收」</strong>。
              透過保持穩定的車速與較大的跟車距離，我們可以避免將前方的速度波動放大傳遞給後方，進而減緩整體車流的壅塞。<br><br>
              於是我做了這個模擬，讓你親眼看看：一個「佛系駕駛」如何默默改善交通。
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- 教育說明 -->
    <div class="row mt-4 mb-5">
      <div class="col-12">
        <div class="card border-0 shadow-sm" style="background: rgba(44, 62, 80, 0.4);">
          <div class="card-body">
            <h4 class="mb-3">為什麼會塞車？</h4>
            <div class="row g-4">
              <div class="col-md-4">
                <h6 style="color: #e74c3c;">幽靈塞車 (Phantom Traffic Jam)</h6>
                <p class="small text-muted mb-0">
                  當一輛車稍微減速，後方車輛需要更大幅度的減速來維持安全距離。
                  這個「減速波」會向後傳播，最終導致後方車輛完全停止，
                  即使最初的減速只是輕微的。
                </p>
              </div>
              <div class="col-md-4">
                <h6 style="color: #3498db;">吸收者的作用</h6>
                <p class="small text-muted mb-0">
                  吸收者車輛保持較大的跟車距離，能夠「吸收」前方的速度波動，
                  避免將減速放大傳遞給後方車輛。
                  這就是為什麼部分自動駕駛車輛可以緩解塞車。
                </p>
              </div>
              <div class="col-md-4">
                <h6 style="color: #f39c12;">試試看！</h6>
                <p class="small text-muted mb-0">
                  調整吸收者比例，觀察「速度波動」指標的變化。
                  研究顯示，只需約 5% 的車輛採用吸收策略，
                  就能顯著改善交通流量！
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { TrafficSimulator } from '@/lib/math/TrafficSimulator';

  document.addEventListener('DOMContentLoaded', () => {
    // DOM 元素
    const playBtn = document.getElementById('playBtn') as HTMLButtonElement;
    const pauseBtn = document.getElementById('pauseBtn') as HTMLButtonElement;
    const resetBtn = document.getElementById('resetBtn') as HTMLButtonElement;
    const speedBtnGroup = document.getElementById('speedBtnGroup') as HTMLDivElement;

    const totalVehiclesSlider = document.getElementById('totalVehicles') as HTMLInputElement;
    const normalRatioSlider = document.getElementById('normalRatio') as HTMLInputElement;
    const disruptorRatioSlider = document.getElementById('disruptorRatio') as HTMLInputElement;
    const absorberRatioSlider = document.getElementById('absorberRatio') as HTMLInputElement;
    const disruptionFreqSlider = document.getElementById('disruptionFreq') as HTMLInputElement;
    const disruptionStrengthSlider = document.getElementById('disruptionStrength') as HTMLInputElement;

    const totalVehiclesValue = document.getElementById('totalVehiclesValue') as HTMLSpanElement;
    const normalRatioValue = document.getElementById('normalRatioValue') as HTMLSpanElement;
    const disruptorRatioValue = document.getElementById('disruptorRatioValue') as HTMLSpanElement;
    const absorberRatioValue = document.getElementById('absorberRatioValue') as HTMLSpanElement;
    const disruptionFreqValue = document.getElementById('disruptionFreqValue') as HTMLSpanElement;
    const disruptionStrengthValue = document.getElementById('disruptionStrengthValue') as HTMLSpanElement;

    const avgVelocityEl = document.getElementById('avgVelocity') as HTMLHeadingElement;
    const velocityStdDevEl = document.getElementById('velocityStdDev') as HTMLHeadingElement;
    const simTimeEl = document.getElementById('simTime') as HTMLHeadingElement;

    // 初始化模擬器
    const sim = new TrafficSimulator('trafficCanvas', {
      onStatsUpdate: (stats) => {
        avgVelocityEl.textContent = stats.averageVelocity.toFixed(3);
        velocityStdDevEl.textContent = stats.velocityStdDev.toFixed(4);

        const mins = Math.floor(stats.time / 60);
        const secs = Math.floor(stats.time % 60);
        simTimeEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      },
      onStateChange: (state) => {
        playBtn.disabled = state === 'running';
        pauseBtn.disabled = state !== 'running';
      }
    });

    sim.setHistoryCanvas('historyChart');

    // 初始配置
    const getConfig = () => ({
      totalVehicles: parseInt(totalVehiclesSlider.value),
      normalRatio: parseInt(normalRatioSlider.value) / 100,
      disruptorRatio: parseInt(disruptorRatioSlider.value) / 100,
      absorberRatio: parseInt(absorberRatioSlider.value) / 100,
      trackRadius: 160,
      baseDesiredVelocity: 0.8,
      disruptionFrequency: parseFloat(disruptionFreqSlider.value),
      disruptionStrength: parseInt(disruptionStrengthSlider.value) / 100,
      timeScale: 1
    });

    sim.init(getConfig());

    // 控制按鈕事件
    playBtn.addEventListener('click', () => {
      const state = sim.getState();
      if (state === 'idle') {
        sim.start();
      } else if (state === 'paused') {
        sim.resume();
      }
    });

    pauseBtn.addEventListener('click', () => {
      sim.pause();
    });

    resetBtn.addEventListener('click', () => {
      sim.reset();
      sim.init(getConfig());
    });

    // 速度按鈕
    speedBtnGroup.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        speedBtnGroup.querySelectorAll('button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        sim.setTimeScale(parseFloat(btn.dataset.speed || '1'));
      });
    });

    // 滑桿事件
    totalVehiclesSlider.addEventListener('input', () => {
      totalVehiclesValue.textContent = totalVehiclesSlider.value;
      sim.updateConfig('totalVehicles', parseInt(totalVehiclesSlider.value));
    });

    // 車輛比例：正規化顯示實際百分比
    const updateRatioDisplay = () => {
      const normal = parseInt(normalRatioSlider.value);
      const disruptor = parseInt(disruptorRatioSlider.value);
      const absorber = parseInt(absorberRatioSlider.value);
      const total = normal + disruptor + absorber;

      if (total === 0) {
        normalRatioValue.textContent = '0%';
        disruptorRatioValue.textContent = '0%';
        absorberRatioValue.textContent = '0%';
      } else {
        normalRatioValue.textContent = Math.round(normal / total * 100) + '%';
        disruptorRatioValue.textContent = Math.round(disruptor / total * 100) + '%';
        absorberRatioValue.textContent = Math.round(absorber / total * 100) + '%';
      }

      sim.updateConfig('normalRatio', normal / 100);
      sim.updateConfig('disruptorRatio', disruptor / 100);
      sim.updateConfig('absorberRatio', absorber / 100);
    };

    normalRatioSlider.addEventListener('input', updateRatioDisplay);
    disruptorRatioSlider.addEventListener('input', updateRatioDisplay);
    absorberRatioSlider.addEventListener('input', updateRatioDisplay);
    updateRatioDisplay(); // 初始化顯示

    disruptionFreqSlider.addEventListener('input', () => {
      disruptionFreqValue.textContent = disruptionFreqSlider.value + ' 次/秒';
      sim.updateConfig('disruptionFrequency', parseFloat(disruptionFreqSlider.value));
    });

    disruptionStrengthSlider.addEventListener('input', () => {
      disruptionStrengthValue.textContent = disruptionStrengthSlider.value + '%';
      sim.updateConfig('disruptionStrength', parseInt(disruptionStrengthSlider.value) / 100);
    });

    // 清理
    window.addEventListener('beforeunload', () => {
      sim.destroy();
    });
  });
</script>
