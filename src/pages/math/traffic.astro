---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---

<BaseLayout
  title="交通流體力學模擬 | 幽靈塞車與交通波吸收視覺化"
  description="為什麼高速公路會無故塞車？互動式模擬讓你親眼看見「幽靈塞車」如何產生，以及佛系駕駛的「交通波吸收」策略如何改善車流。"
>
  <Navbar currentPage="math" />

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8 mb-8">
    <!-- 標題 -->
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold text-base-50 mb-2">🚗 交通流體力學模擬</h1>
      <p class="text-base-400">觀察「幽靈塞車」如何在無明確原因下產生與傳播</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左側：Canvas -->
      <div class="lg:col-span-2 space-y-4">
        <div class="rounded-lg border border-base-600 bg-base-900 overflow-hidden shadow-lg relative">
          <canvas id="trafficCanvas" class="w-full" style="height: 450px;"></canvas>
          
          <div class="absolute top-3 right-3 flex gap-2">
            <span class="px-2 py-1 rounded text-xs font-bold" style="background: #2ecc71;">正常車</span>
            <span class="px-2 py-1 rounded text-xs font-bold" style="background: #e74c3c;">擾動者</span>
            <span class="px-2 py-1 rounded text-xs font-bold" style="background: #3498db;">吸收者</span>
          </div>
        </div>

        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-2 bg-base-600/30 border-b border-base-600 text-sm text-base-400">平均速度歷史</div>
          <div class="p-2 bg-base-900">
            <canvas id="historyChart" class="w-full" style="height: 80px;"></canvas>
          </div>
        </div>
      </div>

      <!-- 右側：控制面板 -->
      <div class="space-y-4">
        <!-- 播放控制 -->
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-2 bg-base-600/30 border-b border-base-600 text-base-50">控制</div>
          <div class="p-4">
            <div class="grid grid-cols-3 gap-2 mb-4">
              <button id="playBtn" class="px-4 py-2 rounded bg-accent-green hover:bg-accent-green/80 text-base-50 font-medium transition">
                ▶ 播放
              </button>
              <button id="pauseBtn" class="px-4 py-2 rounded bg-accent-yellow hover:bg-accent-yellow/80 text-base-900 font-medium transition disabled:opacity-50" disabled>
                ⏸ 暫停
              </button>
              <button id="resetBtn" class="px-4 py-2 rounded border border-base-600 text-base-400 hover:bg-base-600 font-medium transition">
                ↺ 重置
              </button>
            </div>

            <label class="block text-sm text-base-400 mb-2">播放速度</label>
            <div id="speedBtnGroup" class="grid grid-cols-3 gap-2">
              <button class="px-3 py-1 rounded border border-accent-blue text-accent-blue hover:bg-accent-blue/10 text-sm transition" data-speed="0.5">0.5x</button>
              <button class="px-3 py-1 rounded bg-accent-blue text-base-50 text-sm transition active" data-speed="1">1x</button>
              <button class="px-3 py-1 rounded border border-accent-blue text-accent-blue hover:bg-accent-blue/10 text-sm transition" data-speed="2">2x</button>
            </div>
          </div>
        </div>

        <!-- 車輛設定 -->
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-2 bg-base-600/30 border-b border-base-600 text-base-50">車輛設定</div>
          <div class="p-4 space-y-4">
            <div>
              <label class="flex justify-between text-sm mb-1">
                <span class="text-base-400">總車輛數</span>
                <span id="totalVehiclesValue" class="text-base-50">30</span>
              </label>
              <input type="range" id="totalVehicles" min="10" max="50" value="30" class="w-full">
            </div>

            <div>
              <label class="flex justify-between text-sm mb-1">
                <span style="color: #2ecc71;">正常車</span>
                <span id="normalRatioValue" class="text-base-50">60%</span>
              </label>
              <input type="range" id="normalRatio" min="0" max="100" value="60" class="w-full">
            </div>

            <div>
              <label class="flex justify-between text-sm mb-1">
                <span style="color: #e74c3c;">擾動者</span>
                <span id="disruptorRatioValue" class="text-base-50">20%</span>
              </label>
              <input type="range" id="disruptorRatio" min="0" max="100" value="20" class="w-full">
            </div>

            <div>
              <label class="flex justify-between text-sm mb-1">
                <span style="color: #3498db;">吸收者</span>
                <span id="absorberRatioValue" class="text-base-50">20%</span>
              </label>
              <input type="range" id="absorberRatio" min="0" max="100" value="20" class="w-full">
            </div>
          </div>
        </div>

        <!-- 擾動參數 -->
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-2 bg-base-600/30 border-b border-base-600 text-base-50">擾動參數</div>
          <div class="p-4 space-y-4">
            <div>
              <label class="flex justify-between text-sm mb-1">
                <span class="text-base-400">擾動頻率</span>
                <span id="disruptionFreqValue" class="text-base-50">0.5 次/秒</span>
              </label>
              <input type="range" id="disruptionFreq" min="0.1" max="2" step="0.1" value="0.5" class="w-full">
            </div>

            <div>
              <label class="flex justify-between text-sm mb-1">
                <span class="text-base-400">擾動強度</span>
                <span id="disruptionStrengthValue" class="text-base-50">50%</span>
              </label>
              <input type="range" id="disruptionStrength" min="10" max="100" value="50" class="w-full">
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 統計區 -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
      <div class="rounded-lg border border-accent-blue bg-base-800 p-4 text-center">
        <h6 class="text-base-600 text-sm mb-1">平均速度</h6>
        <h3 class="text-2xl font-bold text-base-50" id="avgVelocity">--</h3>
      </div>
      <div class="rounded-lg border border-accent-yellow bg-base-800 p-4 text-center">
        <h6 class="text-base-600 text-sm mb-1">速度波動 (標準差)</h6>
        <h3 class="text-2xl font-bold text-base-50" id="velocityStdDev">--</h3>
      </div>
      <div class="rounded-lg border border-accent-green bg-base-800 p-4 text-center">
        <h6 class="text-base-600 text-sm mb-1">模擬時間</h6>
        <h3 class="text-2xl font-bold text-base-50" id="simTime">0:00</h3>
      </div>
    </div>

    <!-- 創作緣起 -->
    <div class="rounded-lg bg-accent-green/15 mt-6 p-6">
      <h4 class="text-xl font-bold text-base-50 mb-3">💡 創作緣起</h4>
      <p class="text-base-400 leading-relaxed">
        在高速公路開車時，我常常在想：<strong class="text-base-50">我能不能保持車速穩定？</strong><br><br>
        譬如前車減速了，但我其實不必急著跟著煞車——因為在我逼近到危險距離之前，他可能就已經加速離開了。<br>
        又譬如塞車時，前車起步衝刺，但我也不必猛踩油門追上去——反正他待會又會因為前方壅塞而停下來。<br><br>
        這種「不急著反應」的駕駛方式，其實就是交通工程中所謂的<strong class="text-base-50">「交通波吸收」</strong>。
        透過保持穩定的車速與較大的跟車距離，我們可以避免將前方的速度波動放大傳遞給後方，進而減緩整體車流的壅塞。
      </p>
      <div class="mt-4">
        <a href="/blog/traffic-flow-simulation/" class="px-4 py-2 rounded border border-accent-green text-accent-green hover:bg-accent-green/10 transition">閱讀開發筆記 →</a>
      </div>
    </div>

    <!-- 教育說明 -->
    <div class="rounded-lg bg-base-800/50 mt-6 p-6">
      <h4 class="text-xl font-bold text-base-50 mb-4">🔬 為什麼會塞車？</h4>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <h6 class="font-bold mb-2" style="color: #e74c3c;">幽靈塞車 (Phantom Traffic Jam)</h6>
          <p class="text-sm text-base-600">
            當一輛車稍微減速，後方車輛需要更大幅度的減速來維持安全距離。
            這個「減速波」會向後傳播，最終導致後方車輛完全停止，即使最初的減速只是輕微的。
          </p>
        </div>
        <div>
          <h6 class="font-bold mb-2" style="color: #3498db;">吸收者的作用</h6>
          <p class="text-sm text-base-600">
            吸收者車輛保持較大的跟車距離，能夠「吸收」前方的速度波動，
            避免將減速放大傳遞給後方車輛。這就是為什麼部分自動駕駛車輛可以緩解塞車。
          </p>
        </div>
        <div>
          <h6 class="font-bold mb-2" style="color: #f39c12;">試試看！</h6>
          <p class="text-sm text-base-600">
            調整吸收者比例，觀察「速度波動」指標的變化。
            研究顯示，只需約 5% 的車輛採用吸收策略，就能顯著改善交通流量！
          </p>
        </div>
      </div>
    </div>

    <div class="text-center mt-6">
      <a href="/math/" class="px-4 py-2 rounded border border-base-600 text-base-400 hover:bg-base-600 transition">← 返回數學工具</a>
    </div>
  </div>
</BaseLayout>

<script>
  import { TrafficSimulator } from '@/lib/math/TrafficSimulator';

  document.addEventListener('DOMContentLoaded', () => {
    const playBtn = document.getElementById('playBtn') as HTMLButtonElement;
    const pauseBtn = document.getElementById('pauseBtn') as HTMLButtonElement;
    const resetBtn = document.getElementById('resetBtn') as HTMLButtonElement;
    const speedBtnGroup = document.getElementById('speedBtnGroup') as HTMLDivElement;

    const totalVehiclesSlider = document.getElementById('totalVehicles') as HTMLInputElement;
    const normalRatioSlider = document.getElementById('normalRatio') as HTMLInputElement;
    const disruptorRatioSlider = document.getElementById('disruptorRatio') as HTMLInputElement;
    const absorberRatioSlider = document.getElementById('absorberRatio') as HTMLInputElement;
    const disruptionFreqSlider = document.getElementById('disruptionFreq') as HTMLInputElement;
    const disruptionStrengthSlider = document.getElementById('disruptionStrength') as HTMLInputElement;

    const totalVehiclesValue = document.getElementById('totalVehiclesValue') as HTMLSpanElement;
    const normalRatioValue = document.getElementById('normalRatioValue') as HTMLSpanElement;
    const disruptorRatioValue = document.getElementById('disruptorRatioValue') as HTMLSpanElement;
    const absorberRatioValue = document.getElementById('absorberRatioValue') as HTMLSpanElement;
    const disruptionFreqValue = document.getElementById('disruptionFreqValue') as HTMLSpanElement;
    const disruptionStrengthValue = document.getElementById('disruptionStrengthValue') as HTMLSpanElement;

    const avgVelocityEl = document.getElementById('avgVelocity') as HTMLHeadingElement;
    const velocityStdDevEl = document.getElementById('velocityStdDev') as HTMLHeadingElement;
    const simTimeEl = document.getElementById('simTime') as HTMLHeadingElement;

    const sim = new TrafficSimulator('trafficCanvas', {
      onStatsUpdate: (stats) => {
        avgVelocityEl.textContent = stats.averageVelocity.toFixed(3);
        velocityStdDevEl.textContent = stats.velocityStdDev.toFixed(4);

        const mins = Math.floor(stats.time / 60);
        const secs = Math.floor(stats.time % 60);
        simTimeEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
      },
      onStateChange: (state) => {
        playBtn.disabled = state === 'running';
        pauseBtn.disabled = state !== 'running';
      }
    });

    sim.setHistoryCanvas('historyChart');

    const getConfig = () => ({
      totalVehicles: parseInt(totalVehiclesSlider.value),
      normalRatio: parseInt(normalRatioSlider.value) / 100,
      disruptorRatio: parseInt(disruptorRatioSlider.value) / 100,
      absorberRatio: parseInt(absorberRatioSlider.value) / 100,
      trackRadius: 160,
      baseDesiredVelocity: 0.8,
      disruptionFrequency: parseFloat(disruptionFreqSlider.value),
      disruptionStrength: parseInt(disruptionStrengthSlider.value) / 100,
      timeScale: 1
    });

    sim.init(getConfig());

    playBtn.addEventListener('click', () => {
      const state = sim.getState();
      if (state === 'idle') {
        sim.start();
      } else if (state === 'paused') {
        sim.resume();
      }
    });

    pauseBtn.addEventListener('click', () => { sim.pause(); });
    resetBtn.addEventListener('click', () => {
      sim.reset();
      sim.init(getConfig());
    });

    speedBtnGroup.querySelectorAll('button').forEach(btn => {
      btn.addEventListener('click', () => {
        speedBtnGroup.querySelectorAll('button').forEach(b => {
          b.className = 'px-3 py-1 rounded border border-accent-blue text-accent-blue hover:bg-accent-blue/10 text-sm transition';
        });
        btn.className = 'px-3 py-1 rounded bg-accent-blue text-base-50 text-sm transition active';
        sim.setTimeScale(parseFloat(btn.dataset.speed || '1'));
      });
    });

    totalVehiclesSlider.addEventListener('input', () => {
      totalVehiclesValue.textContent = totalVehiclesSlider.value;
      sim.updateConfig('totalVehicles', parseInt(totalVehiclesSlider.value));
    });

    const updateRatioDisplay = () => {
      const normal = parseInt(normalRatioSlider.value);
      const disruptor = parseInt(disruptorRatioSlider.value);
      const absorber = parseInt(absorberRatioSlider.value);
      const total = normal + disruptor + absorber;

      if (total === 0) {
        normalRatioValue.textContent = '0%';
        disruptorRatioValue.textContent = '0%';
        absorberRatioValue.textContent = '0%';
      } else {
        normalRatioValue.textContent = Math.round(normal / total * 100) + '%';
        disruptorRatioValue.textContent = Math.round(disruptor / total * 100) + '%';
        absorberRatioValue.textContent = Math.round(absorber / total * 100) + '%';
      }

      sim.updateConfig('normalRatio', normal / 100);
      sim.updateConfig('disruptorRatio', disruptor / 100);
      sim.updateConfig('absorberRatio', absorber / 100);
    };

    normalRatioSlider.addEventListener('input', updateRatioDisplay);
    disruptorRatioSlider.addEventListener('input', updateRatioDisplay);
    absorberRatioSlider.addEventListener('input', updateRatioDisplay);
    updateRatioDisplay();

    disruptionFreqSlider.addEventListener('input', () => {
      disruptionFreqValue.textContent = disruptionFreqSlider.value + ' 次/秒';
      sim.updateConfig('disruptionFrequency', parseFloat(disruptionFreqSlider.value));
    });

    disruptionStrengthSlider.addEventListener('input', () => {
      disruptionStrengthValue.textContent = disruptionStrengthSlider.value + '%';
      sim.updateConfig('disruptionStrength', parseInt(disruptionStrengthSlider.value) / 100);
    });

    window.addEventListener('beforeunload', () => { sim.destroy(); });
  });
</script>
