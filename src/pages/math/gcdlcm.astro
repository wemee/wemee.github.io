---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout 
  title="æ•¸å­¸è¨ˆç®—å·¥å…· (GCD/LCM/è³ªæ•¸) | æŒ«å±å‹‡çš„æ•¸å­¸æ•™å®¤" 
  description="å…è²»çš„ç·šä¸Šæ•¸å­¸è¨ˆç®—å·¥å…·ï¼ŒåŒ…å«ï¼šè³ªæ•¸æª¢æŸ¥ã€è³ªå› æ•¸åˆ†è§£ã€æœ€å¤§å…¬å› æ•¸ (GCD) è¨ˆç®—ã€æœ€å°å…¬å€æ•¸ (LCM) è¨ˆç®—ã€‚å³æ™‚è¨ˆç®—ï¼Œæ”¯æ´å¤§æ•¸é‹ç®—ã€‚"
>
  <Navbar currentPage="math" />
  <div class="container mt-5">
    <h1 class="text-center mb-4">ğŸ§® æ•¸å­¸è¨ˆç®—å·¥å…·</h1>
    
    <!-- è³ªæ•¸æª¢æŸ¥ -->
    <section class="card mb-4">
      <div class="card-header">
        <h2 class="h5 mb-0">è³ªæ•¸æª¢æŸ¥</h2>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label for="primeInput" class="form-label">è¼¸å…¥æ•¸å­—</label>
            <input type="text" class="form-control" id="primeInput" placeholder="è¼¸å…¥ä¸€å€‹æ•´æ•¸">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" id="primeButton">æª¢æŸ¥</button>
          </div>
        </div>
        <div class="mt-3" id="primeResult"></div>
      </div>
    </section>

    <!-- è³ªå› æ•¸åˆ†è§£ -->
    <section class="card mb-4">
      <div class="card-header">
        <h2 class="h5 mb-0">è³ªå› æ•¸åˆ†è§£</h2>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-8">
            <label for="factorInput" class="form-label">è¼¸å…¥æ•¸å­—</label>
            <input type="text" class="form-control" id="factorInput" placeholder="è¼¸å…¥ä¸€å€‹å¤§æ–¼ 1 çš„æ•´æ•¸">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" id="factorButton">åˆ†è§£</button>
          </div>
        </div>
        <div class="mt-3" id="factorResult"></div>
      </div>
    </section>

    <!-- æœ€å¤§å…¬å› æ•¸ -->
    <section class="card mb-4">
      <div class="card-header">
        <h2 class="h5 mb-0">æœ€å¤§å…¬å› æ•¸ (GCD)</h2>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="gcdInput1" class="form-label">ç¬¬ä¸€å€‹æ•¸å­—</label>
            <input type="text" class="form-control" id="gcdInput1" placeholder="æ•´æ•¸">
          </div>
          <div class="col-md-4">
            <label for="gcdInput2" class="form-label">ç¬¬äºŒå€‹æ•¸å­—</label>
            <input type="text" class="form-control" id="gcdInput2" placeholder="æ•´æ•¸">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" id="gcdButton">è¨ˆç®— GCD</button>
          </div>
        </div>
        <div class="mt-3" id="gcdResult"></div>
      </div>
    </section>

    <!-- æœ€å°å…¬å€æ•¸ -->
    <section class="card mb-4">
      <div class="card-header">
        <h2 class="h5 mb-0">æœ€å°å…¬å€æ•¸ (LCM)</h2>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-end">
          <div class="col-md-4">
            <label for="lcmInput1" class="form-label">ç¬¬ä¸€å€‹æ•¸å­—</label>
            <input type="text" class="form-control" id="lcmInput1" placeholder="æ•´æ•¸">
          </div>
          <div class="col-md-4">
            <label for="lcmInput2" class="form-label">ç¬¬äºŒå€‹æ•¸å­—</label>
            <input type="text" class="form-control" id="lcmInput2" placeholder="æ•´æ•¸">
          </div>
          <div class="col-md-4">
            <button class="btn btn-primary w-100" id="lcmButton">è¨ˆç®— LCM</button>
          </div>
        </div>
        <div class="mt-3" id="lcmResult"></div>
      </div>
    </section>
  </div>
</BaseLayout>

<script>
  // === å·¥å…·å‡½æ•¸ ===
  function parseBigInt(value: string): bigint | null {
    try {
      const trimmed = value.trim();
      if (!/^-?\d+$/.test(trimmed)) return null;
      return BigInt(trimmed);
    } catch {
      return null;
    }
  }

  function showResult(elementId: string, message: string, isError = false) {
    const el = document.getElementById(elementId);
    if (el) {
      const alertClass = isError ? 'alert-danger' : 'alert-success';
      el.innerHTML = `<div class="alert ${alertClass} mb-0">${message}</div>`;
    }
  }

  function appendResult(elementId: string, message: string) {
    const el = document.getElementById(elementId);
    if (el) {
      el.innerHTML += `<div class="small text-muted">${message}</div>`;
    }
  }

  // === è³ªæ•¸ç›¸é—œ ===
  let primes: bigint[] = [2n, 3n, 5n, 7n, 11n, 13n];
  let stopCalculation = false;

  function addNewPrime(): bigint {
    let candidate = primes[primes.length - 1] + 2n;
    while (!isPrimeQuick(candidate)) {
      candidate += 2n;
    }
    primes.push(candidate);
    return candidate;
  }

  function isPrimeQuick(num: bigint): boolean {
    if (num <= 1n) return false;
    if (num <= 3n) return true;
    if (num % 2n === 0n) return false;

    const sqrtNum = BigInt(Math.ceil(Math.sqrt(Number(num))));
    for (const p of primes) {
      if (p > sqrtNum) return true;
      if (num % p === 0n) return false;
    }
    return true;
  }

  function isPrime(num: bigint): boolean | null {
    if (num <= 1n) return false;
    if (num <= 3n) return true;
    if (num % 2n === 0n) return false;

    const sqrtNum = BigInt(Math.ceil(Math.sqrt(Number(num))));
    
    for (const p of primes) {
      if (stopCalculation) return null;
      if (p > sqrtNum) return true;
      if (num % p === 0n) return false;
    }

    let p = addNewPrime();
    while (p <= sqrtNum) {
      if (stopCalculation) return null;
      if (num % p === 0n) return false;
      p = addNewPrime();
    }
    return true;
  }

  // === è³ªæ•¸æª¢æŸ¥ ===
  function checkPrime() {
    const input = (document.getElementById('primeInput') as HTMLInputElement).value;
    const num = parseBigInt(input);

    if (num === null) {
      showResult('primeResult', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•´æ•¸', true);
      return;
    }

    stopCalculation = false;
    const result = isPrime(num);

    if (result === null) {
      showResult('primeResult', `${num}ï¼šè¨ˆç®—å·²åœæ­¢`, true);
    } else if (result) {
      showResult('primeResult', `${num} æ˜¯è³ªæ•¸ âœ“`);
    } else {
      showResult('primeResult', `${num} ä¸æ˜¯è³ªæ•¸ âœ—`);
    }
  }

  // === è³ªå› æ•¸åˆ†è§£ ===
  function factorize() {
    const input = (document.getElementById('factorInput') as HTMLInputElement).value;
    let num = parseBigInt(input);

    if (num === null || num <= 1n) {
      showResult('factorResult', 'è«‹è¼¸å…¥å¤§æ–¼ 1 çš„æ•´æ•¸', true);
      return;
    }

    const factors: bigint[] = [];
    const original = num;

    while (num % 2n === 0n) {
      factors.push(2n);
      num /= 2n;
    }

    let divisor = 3n;
    while (divisor * divisor <= num) {
      while (num % divisor === 0n) {
        factors.push(divisor);
        num /= divisor;
      }
      divisor += 2n;
    }

    if (num > 1n) {
      factors.push(num);
    }

    if (factors.length === 1) {
      showResult('factorResult', `${original} æ˜¯è³ªæ•¸`);
    } else {
      showResult('factorResult', `${original} = ${factors.join(' Ã— ')}`);
    }
  }

  // === GCD / LCM ===
  function gcd(a: bigint, b: bigint): bigint {
    a = a < 0n ? -a : a;
    b = b < 0n ? -b : b;
    return b === 0n ? a : gcd(b, a % b);
  }

  function lcm(a: bigint, b: bigint): bigint {
    return (a * b) / gcd(a, b);
  }

  function calculateGCD() {
    const input1 = (document.getElementById('gcdInput1') as HTMLInputElement).value;
    const input2 = (document.getElementById('gcdInput2') as HTMLInputElement).value;
    const num1 = parseBigInt(input1);
    const num2 = parseBigInt(input2);

    if (num1 === null || num2 === null || num1 <= 0n || num2 <= 0n) {
      showResult('gcdResult', 'è«‹è¼¸å…¥å…©å€‹å¤§æ–¼ 0 çš„æ•´æ•¸', true);
      return;
    }

    const result = gcd(num1, num2);
    showResult('gcdResult', `GCD(${num1}, ${num2}) = ${result}`);
  }

  function calculateLCM() {
    const input1 = (document.getElementById('lcmInput1') as HTMLInputElement).value;
    const input2 = (document.getElementById('lcmInput2') as HTMLInputElement).value;
    const num1 = parseBigInt(input1);
    const num2 = parseBigInt(input2);

    if (num1 === null || num2 === null || num1 <= 0n || num2 <= 0n) {
      showResult('lcmResult', 'è«‹è¼¸å…¥å…©å€‹å¤§æ–¼ 0 çš„æ•´æ•¸', true);
      return;
    }

    const result = lcm(num1, num2);
    showResult('lcmResult', `LCM(${num1}, ${num2}) = ${result}`);
  }

  // === äº‹ä»¶ç¶å®š ===
  document.getElementById('primeButton')?.addEventListener('click', checkPrime);
  document.getElementById('factorButton')?.addEventListener('click', factorize);
  document.getElementById('gcdButton')?.addEventListener('click', calculateGCD);
  document.getElementById('lcmButton')?.addEventListener('click', calculateLCM);

  // Enter éµæ”¯æ´
  document.getElementById('primeInput')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') checkPrime();
  });
  document.getElementById('factorInput')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') factorize();
  });
  document.getElementById('gcdInput2')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') calculateGCD();
  });
  document.getElementById('lcmInput2')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') calculateLCM();
  });
</script>
