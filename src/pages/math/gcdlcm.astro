---
import BaseLayout from '@/layouts/BaseLayout.astro';
---
<BaseLayout currentPage="math" currentPage="math" 
  title="æ•¸å­¸è¨ˆç®—å·¥å…· (GCD/LCM/è³ªæ•¸) | æŒ«å±å‹‡çš„æ•¸å­¸æ•™å®¤" 
  description="å…è²»çš„ç·šä¸Šæ•¸å­¸è¨ˆç®—å·¥å…·ï¼ŒåŒ…å«ï¼šè³ªæ•¸æª¢æŸ¥ã€è³ªå› æ•¸åˆ†è§£ã€æœ€å¤§å…¬å› æ•¸ (GCD) è¨ˆç®—ã€æœ€å°å…¬å€æ•¸ (LCM) è¨ˆç®—ã€‚å³æ™‚è¨ˆç®—ï¼Œæ”¯æ´å¤§æ•¸é‹ç®—ã€‚"
>
  <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <h1 class="text-center text-3xl font-bold text-base-50 mb-6">ğŸ§® æ•¸å­¸è¨ˆç®—å·¥å…·</h1>
    
    <!-- è³ªæ•¸æª¢æŸ¥ -->
    <section class="rounded-lg border border-base-600 bg-base-800 mb-4 overflow-hidden">
      <div class="px-4 py-3 bg-base-600/30 border-b border-base-600">
        <h2 class="text-lg font-semibold text-base-50">è³ªæ•¸æª¢æŸ¥</h2>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
          <div class="md:col-span-3">
            <label for="primeInput" class="block text-sm text-base-400 mb-1">è¼¸å…¥æ•¸å­—</label>
            <input type="text" id="primeInput" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-blue focus:outline-none" placeholder="è¼¸å…¥ä¸€å€‹æ•´æ•¸">
          </div>
          <div>
            <button id="primeButton" class="w-full px-4 py-2 rounded bg-accent-blue hover:bg-accent-blue/80 text-base-50 font-medium transition">æª¢æŸ¥</button>
          </div>
        </div>
        <div id="primeResult" class="mt-3"></div>
      </div>
    </section>

    <!-- è³ªå› æ•¸åˆ†è§£ -->
    <section class="rounded-lg border border-base-600 bg-base-800 mb-4 overflow-hidden">
      <div class="px-4 py-3 bg-base-600/30 border-b border-base-600">
        <h2 class="text-lg font-semibold text-base-50">è³ªå› æ•¸åˆ†è§£</h2>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3 items-end">
          <div class="md:col-span-3">
            <label for="factorInput" class="block text-sm text-base-400 mb-1">è¼¸å…¥æ•¸å­—</label>
            <input type="text" id="factorInput" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-blue focus:outline-none" placeholder="è¼¸å…¥ä¸€å€‹å¤§æ–¼ 1 çš„æ•´æ•¸">
          </div>
          <div>
            <button id="factorButton" class="w-full px-4 py-2 rounded bg-accent-blue hover:bg-accent-blue/80 text-base-50 font-medium transition">åˆ†è§£</button>
          </div>
        </div>
        <div id="factorResult" class="mt-3"></div>
      </div>
    </section>

    <!-- æœ€å¤§å…¬å› æ•¸ -->
    <section class="rounded-lg border border-base-600 bg-base-800 mb-4 overflow-hidden">
      <div class="px-4 py-3 bg-base-600/30 border-b border-base-600">
        <h2 class="text-lg font-semibold text-base-50">æœ€å¤§å…¬å› æ•¸ (GCD)</h2>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
          <div>
            <label for="gcdInput1" class="block text-sm text-base-400 mb-1">ç¬¬ä¸€å€‹æ•¸å­—</label>
            <input type="text" id="gcdInput1" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-blue focus:outline-none" placeholder="æ•´æ•¸">
          </div>
          <div>
            <label for="gcdInput2" class="block text-sm text-base-400 mb-1">ç¬¬äºŒå€‹æ•¸å­—</label>
            <input type="text" id="gcdInput2" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-blue focus:outline-none" placeholder="æ•´æ•¸">
          </div>
          <div>
            <button id="gcdButton" class="w-full px-4 py-2 rounded bg-accent-blue hover:bg-accent-blue/80 text-base-50 font-medium transition">è¨ˆç®— GCD</button>
          </div>
        </div>
        <div id="gcdResult" class="mt-3"></div>
      </div>
    </section>

    <!-- æœ€å°å…¬å€æ•¸ -->
    <section class="rounded-lg border border-base-600 bg-base-800 mb-4 overflow-hidden">
      <div class="px-4 py-3 bg-base-600/30 border-b border-base-600">
        <h2 class="text-lg font-semibold text-base-50">æœ€å°å…¬å€æ•¸ (LCM)</h2>
      </div>
      <div class="p-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
          <div>
            <label for="lcmInput1" class="block text-sm text-base-400 mb-1">ç¬¬ä¸€å€‹æ•¸å­—</label>
            <input type="text" id="lcmInput1" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-blue focus:outline-none" placeholder="æ•´æ•¸">
          </div>
          <div>
            <label for="lcmInput2" class="block text-sm text-base-400 mb-1">ç¬¬äºŒå€‹æ•¸å­—</label>
            <input type="text" id="lcmInput2" class="w-full px-3 py-2 bg-base-900 border border-base-600 rounded text-base-50 focus:border-accent-blue focus:outline-none" placeholder="æ•´æ•¸">
          </div>
          <div>
            <button id="lcmButton" class="w-full px-4 py-2 rounded bg-accent-blue hover:bg-accent-blue/80 text-base-50 font-medium transition">è¨ˆç®— LCM</button>
          </div>
        </div>
        <div id="lcmResult" class="mt-3"></div>
      </div>
    </section>

    <div class="text-center mt-6">
      <a href="/math/" class="px-4 py-2 rounded border border-base-600 text-base-400 hover:bg-base-600 transition">â† è¿”å›æ•¸å­¸å·¥å…·</a>
    </div>
  </div>
</BaseLayout>

<script>
  // === å·¥å…·å‡½æ•¸ ===
  function parseBigInt(value: string): bigint | null {
    try {
      const trimmed = value.trim();
      if (!/^-?\d+$/.test(trimmed)) return null;
      return BigInt(trimmed);
    } catch {
      return null;
    }
  }

  function showResult(elementId: string, message: string, isError = false) {
    const el = document.getElementById(elementId);
    if (el) {
      const bgClass = isError ? 'bg-accent-red/20 border-accent-red text-accent-red' : 'bg-accent-green/20 border-accent-green text-accent-green';
      el.innerHTML = `<div class="p-3 rounded border ${bgClass}">${message}</div>`;
    }
  }

  function appendResult(elementId: string, message: string) {
    const el = document.getElementById(elementId);
    if (el) {
      el.innerHTML += `<div class="text-sm text-base-600">${message}</div>`;
    }
  }

  // === è³ªæ•¸ç›¸é—œ ===
  let primes: bigint[] = [2n, 3n, 5n, 7n, 11n, 13n];
  let stopCalculation = false;

  function addNewPrime(): bigint {
    let candidate = primes[primes.length - 1] + 2n;
    while (!isPrimeQuick(candidate)) {
      candidate += 2n;
    }
    primes.push(candidate);
    return candidate;
  }

  function isPrimeQuick(num: bigint): boolean {
    if (num <= 1n) return false;
    if (num <= 3n) return true;
    if (num % 2n === 0n) return false;

    const sqrtNum = BigInt(Math.ceil(Math.sqrt(Number(num))));
    for (const p of primes) {
      if (p > sqrtNum) return true;
      if (num % p === 0n) return false;
    }
    return true;
  }

  function isPrime(num: bigint): boolean | null {
    if (num <= 1n) return false;
    if (num <= 3n) return true;
    if (num % 2n === 0n) return false;

    const sqrtNum = BigInt(Math.ceil(Math.sqrt(Number(num))));
    
    for (const p of primes) {
      if (stopCalculation) return null;
      if (p > sqrtNum) return true;
      if (num % p === 0n) return false;
    }

    let p = addNewPrime();
    while (p <= sqrtNum) {
      if (stopCalculation) return null;
      if (num % p === 0n) return false;
      p = addNewPrime();
    }
    return true;
  }

  // === è³ªæ•¸æª¢æŸ¥ ===
  function checkPrime() {
    const input = (document.getElementById('primeInput') as HTMLInputElement).value;
    const num = parseBigInt(input);

    if (num === null) {
      showResult('primeResult', 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•´æ•¸', true);
      return;
    }

    stopCalculation = false;
    const result = isPrime(num);

    if (result === null) {
      showResult('primeResult', `${num}ï¼šè¨ˆç®—å·²åœæ­¢`, true);
    } else if (result) {
      showResult('primeResult', `${num} æ˜¯è³ªæ•¸ âœ“`);
    } else {
      showResult('primeResult', `${num} ä¸æ˜¯è³ªæ•¸ âœ—`);
    }
  }

  // === è³ªå› æ•¸åˆ†è§£ ===
  function factorize() {
    const input = (document.getElementById('factorInput') as HTMLInputElement).value;
    let num = parseBigInt(input);

    if (num === null || num <= 1n) {
      showResult('factorResult', 'è«‹è¼¸å…¥å¤§æ–¼ 1 çš„æ•´æ•¸', true);
      return;
    }

    const factors: bigint[] = [];
    const original = num;

    while (num % 2n === 0n) {
      factors.push(2n);
      num /= 2n;
    }

    let divisor = 3n;
    while (divisor * divisor <= num) {
      while (num % divisor === 0n) {
        factors.push(divisor);
        num /= divisor;
      }
      divisor += 2n;
    }

    if (num > 1n) {
      factors.push(num);
    }

    if (factors.length === 1) {
      showResult('factorResult', `${original} æ˜¯è³ªæ•¸`);
    } else {
      showResult('factorResult', `${original} = ${factors.join(' Ã— ')}`);
    }
  }

  // === GCD / LCM ===
  function gcd(a: bigint, b: bigint): bigint {
    a = a < 0n ? -a : a;
    b = b < 0n ? -b : b;
    return b === 0n ? a : gcd(b, a % b);
  }

  function lcm(a: bigint, b: bigint): bigint {
    return (a * b) / gcd(a, b);
  }

  function calculateGCD() {
    const input1 = (document.getElementById('gcdInput1') as HTMLInputElement).value;
    const input2 = (document.getElementById('gcdInput2') as HTMLInputElement).value;
    const num1 = parseBigInt(input1);
    const num2 = parseBigInt(input2);

    if (num1 === null || num2 === null || num1 <= 0n || num2 <= 0n) {
      showResult('gcdResult', 'è«‹è¼¸å…¥å…©å€‹å¤§æ–¼ 0 çš„æ•´æ•¸', true);
      return;
    }

    const result = gcd(num1, num2);
    showResult('gcdResult', `GCD(${num1}, ${num2}) = ${result}`);
  }

  function calculateLCM() {
    const input1 = (document.getElementById('lcmInput1') as HTMLInputElement).value;
    const input2 = (document.getElementById('lcmInput2') as HTMLInputElement).value;
    const num1 = parseBigInt(input1);
    const num2 = parseBigInt(input2);

    if (num1 === null || num2 === null || num1 <= 0n || num2 <= 0n) {
      showResult('lcmResult', 'è«‹è¼¸å…¥å…©å€‹å¤§æ–¼ 0 çš„æ•´æ•¸', true);
      return;
    }

    const result = lcm(num1, num2);
    showResult('lcmResult', `LCM(${num1}, ${num2}) = ${result}`);
  }

  // === äº‹ä»¶ç¶å®š ===
  document.getElementById('primeButton')?.addEventListener('click', checkPrime);
  document.getElementById('factorButton')?.addEventListener('click', factorize);
  document.getElementById('gcdButton')?.addEventListener('click', calculateGCD);
  document.getElementById('lcmButton')?.addEventListener('click', calculateLCM);

  // Enter éµæ”¯æ´
  document.getElementById('primeInput')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') checkPrime();
  });
  document.getElementById('factorInput')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') factorize();
  });
  document.getElementById('gcdInput2')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') calculateGCD();
  });
  document.getElementById('lcmInput2')?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') calculateLCM();
  });
</script>
