---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout title="æ³¢å½¢åˆæˆå™¨">
  <Navbar currentPage="math" />
  <div class="container-fluid mt-4">
    <h1 class="text-center mb-3">ğŸ›ï¸ æ³¢å½¢åˆæˆå™¨</h1>
    <p class="text-center text-muted mb-4">ç–ŠåŠ ä¸åŒé »ç‡çš„æ­£å¼¦æ³¢ï¼Œè¦ªæ‰‹æŠŠåœ“æ»‘çš„æ³¢è®Šæˆæ–¹æ³¢ï¼</p>
    
    <div class="row g-3">
      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="col-lg-4">
        <div class="card">
          <div class="card-header">
            <span>è«§æ³¢æ§åˆ¶</span>
            <button class="btn btn-sm btn-outline-secondary float-end" id="resetBtn">é‡ç½®</button>
          </div>
          <div class="card-body" id="harmonicControls" style="max-height: 400px; overflow-y: auto;">
            <!-- å‹•æ…‹ç”Ÿæˆçš„æ»‘æ¡¿ -->
          </div>
          <div class="card-footer">
            <div class="d-flex justify-content-between align-items-center">
              <span>è«§æ³¢æ•¸é‡:</span>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-outline-primary" id="removeHarmonic">-</button>
                <span class="btn btn-sm btn-light" id="harmonicCount">5</span>
                <button class="btn btn-sm btn-outline-primary" id="addHarmonic">+</button>
              </div>
            </div>
          </div>
        </div>
        
        <!-- é è¨­æ³¢å½¢ -->
        <div class="card mt-3">
          <div class="card-header">å¿«é€Ÿè¼‰å…¥é è¨­æ³¢å½¢</div>
          <div class="card-body">
            <div class="d-grid gap-2">
              <button class="btn btn-outline-success" id="presetSquare">æ–¹æ³¢ (Square)</button>
              <button class="btn btn-outline-info" id="presetSawtooth">é‹¸é½’æ³¢ (Sawtooth)</button>
              <button class="btn btn-outline-warning" id="presetTriangle">ä¸‰è§’æ³¢ (Triangle)</button>
            </div>
          </div>
        </div>
      </div>
      
      <!-- æ³¢å½¢é¡¯ç¤º -->
      <div class="col-lg-8">
        <div class="card mb-3">
          <div class="card-header">æ™‚åŸŸæ³¢å½¢ (Time Domain)</div>
          <div class="card-body p-2">
            <canvas id="waveCanvas" width="700" height="200" style="width: 100%; border: 1px solid #eee;"></canvas>
          </div>
        </div>
        <div class="card">
          <div class="card-header">é »è­œ (Frequency Domain)</div>
          <div class="card-body p-2">
            <canvas id="spectrumCanvas" width="700" height="150" style="width: 100%; border: 1px solid #eee;"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-center mt-4">
      <a href="/math/" class="btn btn-outline-secondary">â† è¿”å›æ•¸å­¸å·¥å…·</a>
    </div>
  </div>
</BaseLayout>

<script>
  interface Harmonic {
    frequency: number;  // è«§æ³¢æ¬¡æ•¸ (1 = åŸºé »)
    amplitude: number;  // æŒ¯å¹… 0-1
  }

  // === å…¨åŸŸè®Šæ•¸ ===
  const waveCanvas = document.getElementById('waveCanvas') as HTMLCanvasElement;
  const spectrumCanvas = document.getElementById('spectrumCanvas') as HTMLCanvasElement;
  const waveCtx = waveCanvas.getContext('2d')!;
  const specCtx = spectrumCanvas.getContext('2d')!;
  
  let harmonics: Harmonic[] = [];
  let harmonicCount = 5;

  // === åˆå§‹åŒ– ===
  function init() {
    harmonics = [];
    for (let i = 1; i <= harmonicCount; i++) {
      harmonics.push({ frequency: i, amplitude: i === 1 ? 1 : 0 });
    }
    renderControls();
    draw();
  }

  // === æ¸²æŸ“æ§åˆ¶é¢æ¿ ===
  function renderControls() {
    const container = document.getElementById('harmonicControls')!;
    container.innerHTML = '';
    
    harmonics.forEach((h, i) => {
      const div = document.createElement('div');
      div.className = 'mb-3';
      div.innerHTML = `
        <label class="form-label d-flex justify-content-between">
          <span>ç¬¬ ${h.frequency} è«§æ³¢</span>
          <span class="text-muted" id="amp${i}">${(h.amplitude * 100).toFixed(0)}%</span>
        </label>
        <input type="range" class="form-range" id="slider${i}" 
               min="0" max="100" value="${h.amplitude * 100}" data-index="${i}">
      `;
      container.appendChild(div);
      
      // ç¶å®šäº‹ä»¶
      const slider = document.getElementById(`slider${i}`) as HTMLInputElement;
      slider.addEventListener('input', (e) => {
        const idx = parseInt((e.target as HTMLInputElement).dataset.index!);
        harmonics[idx].amplitude = parseInt((e.target as HTMLInputElement).value) / 100;
        document.getElementById(`amp${idx}`)!.textContent = 
          (harmonics[idx].amplitude * 100).toFixed(0) + '%';
        draw();
      });
    });
    
    document.getElementById('harmonicCount')!.textContent = harmonicCount.toString();
  }

  // === ç¹ªè£½æ³¢å½¢ ===
  function draw() {
    drawWave();
    drawSpectrum();
  }

  function drawWave() {
    const w = waveCanvas.width;
    const h = waveCanvas.height;
    const centerY = h / 2;
    
    waveCtx.clearRect(0, 0, w, h);
    
    // ç•«ä¸­ç·š
    waveCtx.strokeStyle = '#ddd';
    waveCtx.lineWidth = 1;
    waveCtx.beginPath();
    waveCtx.moveTo(0, centerY);
    waveCtx.lineTo(w, centerY);
    waveCtx.stroke();
    
    // ç•«åˆæˆæ³¢
    waveCtx.strokeStyle = '#78c2ad';
    waveCtx.lineWidth = 2;
    waveCtx.beginPath();
    
    for (let x = 0; x < w; x++) {
      const t = (x / w) * 4 * Math.PI; // é¡¯ç¤º 2 å€‹é€±æœŸ
      let y = 0;
      
      for (const h of harmonics) {
        y += h.amplitude * Math.sin(h.frequency * t);
      }
      
      // æ­£è¦åŒ–
      const maxAmp = harmonics.reduce((sum, h) => sum + h.amplitude, 0) || 1;
      const normalizedY = centerY - (y / maxAmp) * (centerY - 20);
      
      if (x === 0) waveCtx.moveTo(x, normalizedY);
      else waveCtx.lineTo(x, normalizedY);
    }
    
    waveCtx.stroke();
    
    // ç•«å„å€‹è«§æ³¢åˆ†é‡ï¼ˆæ·¡è‰²ï¼‰
    harmonics.forEach((h, i) => {
      if (h.amplitude === 0) return;
      
      const colors = ['#ff6b6b', '#4ecdc4', '#f7dc6f', '#bb8fce', '#85c1e9', '#82e0aa'];
      waveCtx.strokeStyle = colors[i % colors.length] + '80';
      waveCtx.lineWidth = 1;
      waveCtx.beginPath();
      
      for (let x = 0; x < w; x++) {
        const t = (x / w) * 4 * Math.PI;
        const y = h.amplitude * Math.sin(h.frequency * t);
        const maxAmp = harmonics.reduce((sum, h) => sum + h.amplitude, 0) || 1;
        const normalizedY = centerY - (y / maxAmp) * (centerY - 20);
        
        if (x === 0) waveCtx.moveTo(x, normalizedY);
        else waveCtx.lineTo(x, normalizedY);
      }
      
      waveCtx.stroke();
    });
  }

  function drawSpectrum() {
    const w = spectrumCanvas.width;
    const h = spectrumCanvas.height;
    
    specCtx.clearRect(0, 0, w, h);
    
    const barWidth = w / (harmonicCount + 1);
    const maxAmp = Math.max(...harmonics.map(h => h.amplitude), 0.1);
    
    harmonics.forEach((harm, i) => {
      const barHeight = (harm.amplitude / maxAmp) * (h - 30);
      const x = (i + 0.5) * barWidth;
      
      // æ¼¸å±¤è‰²
      const gradient = specCtx.createLinearGradient(x, h - barHeight, x, h);
      gradient.addColorStop(0, '#78c2ad');
      gradient.addColorStop(1, '#56a98f');
      
      specCtx.fillStyle = gradient;
      specCtx.fillRect(x - barWidth * 0.35, h - barHeight - 20, barWidth * 0.7, barHeight);
      
      // æ¨™ç±¤
      specCtx.fillStyle = '#666';
      specCtx.font = '12px Arial';
      specCtx.textAlign = 'center';
      specCtx.fillText(`${harm.frequency}f`, x, h - 5);
    });
  }

  // === é è¨­æ³¢å½¢ ===
  function loadSquareWave() {
    harmonics.forEach((h, i) => {
      const n = i + 1;
      // æ–¹æ³¢åªæœ‰å¥‡æ¬¡è«§æ³¢ï¼ŒæŒ¯å¹…ç‚º 1/n
      h.amplitude = (n % 2 === 1) ? 1 / n : 0;
    });
    renderControls();
    draw();
  }

  function loadSawtoothWave() {
    harmonics.forEach((h, i) => {
      const n = i + 1;
      // é‹¸é½’æ³¢æ‰€æœ‰è«§æ³¢ï¼ŒæŒ¯å¹…ç‚º 1/n
      h.amplitude = 1 / n;
    });
    renderControls();
    draw();
  }

  function loadTriangleWave() {
    harmonics.forEach((h, i) => {
      const n = i + 1;
      // ä¸‰è§’æ³¢åªæœ‰å¥‡æ¬¡è«§æ³¢ï¼ŒæŒ¯å¹…ç‚º 1/nÂ²ï¼Œäº¤æ›¿æ­£è² 
      if (n % 2 === 1) {
        const sign = ((n - 1) / 2) % 2 === 0 ? 1 : -1;
        h.amplitude = Math.abs(sign / (n * n));
      } else {
        h.amplitude = 0;
      }
    });
    renderControls();
    draw();
  }

  // === äº‹ä»¶ç¶å®š ===
  document.getElementById('resetBtn')!.addEventListener('click', init);
  
  document.getElementById('addHarmonic')!.addEventListener('click', () => {
    if (harmonicCount < 20) {
      harmonicCount++;
      harmonics.push({ frequency: harmonicCount, amplitude: 0 });
      renderControls();
      draw();
    }
  });

  document.getElementById('removeHarmonic')!.addEventListener('click', () => {
    if (harmonicCount > 1) {
      harmonicCount--;
      harmonics.pop();
      renderControls();
      draw();
    }
  });

  document.getElementById('presetSquare')!.addEventListener('click', loadSquareWave);
  document.getElementById('presetSawtooth')!.addEventListener('click', loadSawtoothWave);
  document.getElementById('presetTriangle')!.addEventListener('click', loadTriangleWave);

  // åˆå§‹åŒ–
  init();
</script>

<style>
  canvas {
    background: #fafafa;
  }
</style>
