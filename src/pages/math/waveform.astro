---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
---
<BaseLayout title="æ³¢å½¢åˆæˆå™¨">
  <Navbar currentPage="math" />
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-8">
    <h1 class="text-center text-3xl font-bold text-base-50 mb-2">ğŸ›ï¸ æ³¢å½¢åˆæˆå™¨</h1>
    <p class="text-center text-base-400 mb-6">ç–ŠåŠ ä¸åŒé »ç‡çš„æ­£å¼¦æ³¢ï¼Œè¦ªæ‰‹æŠŠåœ“æ»‘çš„æ³¢è®Šæˆæ–¹æ³¢ï¼</p>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <!-- æ§åˆ¶é¢æ¿ -->
      <div class="space-y-4">
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 flex items-center justify-between">
            <span class="text-base-50">è«§æ³¢æ§åˆ¶</span>
            <button id="resetBtn" class="px-3 py-1 rounded border border-base-600 text-base-400 hover:bg-base-600 text-sm transition">é‡ç½®</button>
          </div>
          <div id="harmonicControls" class="p-4 max-h-96 overflow-y-auto">
            <!-- å‹•æ…‹ç”Ÿæˆçš„æ»‘æ¡¿ -->
          </div>
          <div class="px-4 py-3 border-t border-base-600 flex items-center justify-between">
            <span class="text-base-400">è«§æ³¢æ•¸é‡:</span>
            <div class="flex">
              <button id="removeHarmonic" class="px-3 py-1 border border-base-600 rounded-l text-base-400 hover:bg-base-600 transition">-</button>
              <span id="harmonicCount" class="px-4 py-1 bg-base-600 text-base-50">5</span>
              <button id="addHarmonic" class="px-3 py-1 border border-base-600 rounded-r text-base-400 hover:bg-base-600 transition">+</button>
            </div>
          </div>
        </div>
        
        <!-- é è¨­æ³¢å½¢ -->
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 text-base-50">å¿«é€Ÿè¼‰å…¥é è¨­æ³¢å½¢</div>
          <div class="p-4 space-y-2">
            <button id="presetSquare" class="w-full px-4 py-2 rounded border border-accent-green text-accent-green hover:bg-accent-green/10 transition">æ–¹æ³¢ (Square)</button>
            <button id="presetSawtooth" class="w-full px-4 py-2 rounded border border-accent-cyan text-accent-cyan hover:bg-accent-cyan/10 transition">é‹¸é½’æ³¢ (Sawtooth)</button>
            <button id="presetTriangle" class="w-full px-4 py-2 rounded border border-accent-yellow text-accent-yellow hover:bg-accent-yellow/10 transition">ä¸‰è§’æ³¢ (Triangle)</button>
          </div>
        </div>
      </div>
      
      <!-- æ³¢å½¢é¡¯ç¤º -->
      <div class="lg:col-span-2 space-y-4">
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 text-base-50">æ™‚åŸŸæ³¢å½¢ (Time Domain)</div>
          <div class="p-2">
            <canvas id="waveCanvas" width="700" height="200" class="w-full border border-base-600 rounded"></canvas>
          </div>
        </div>
        <div class="rounded-lg border border-base-600 bg-base-800 overflow-hidden">
          <div class="px-4 py-3 bg-base-600/30 border-b border-base-600 text-base-50">é »è­œ (Frequency Domain)</div>
          <div class="p-2">
            <canvas id="spectrumCanvas" width="700" height="150" class="w-full border border-base-600 rounded"></canvas>
          </div>
        </div>
      </div>
    </div>
    
    <div class="text-center mt-6">
      <a href="/math/" class="px-4 py-2 rounded border border-base-600 text-base-400 hover:bg-base-600 transition">â† è¿”å›æ•¸å­¸å·¥å…·</a>
    </div>
  </div>
</BaseLayout>

<script>
  interface Harmonic {
    frequency: number;
    amplitude: number;
  }

  const waveCanvas = document.getElementById('waveCanvas') as HTMLCanvasElement;
  const spectrumCanvas = document.getElementById('spectrumCanvas') as HTMLCanvasElement;
  const waveCtx = waveCanvas.getContext('2d')!;
  const specCtx = spectrumCanvas.getContext('2d')!;
  
  let harmonics: Harmonic[] = [];
  let harmonicCount = 5;

  function init() {
    harmonics = [];
    for (let i = 1; i <= harmonicCount; i++) {
      harmonics.push({ frequency: i, amplitude: i === 1 ? 1 : 0 });
    }
    renderControls();
    draw();
  }

  function renderControls() {
    const container = document.getElementById('harmonicControls')!;
    container.innerHTML = '';
    
    harmonics.forEach((h, i) => {
      const div = document.createElement('div');
      div.className = 'mb-4';
      div.innerHTML = `
        <label class="flex justify-between text-sm mb-1">
          <span class="text-base-400">ç¬¬ ${h.frequency} è«§æ³¢</span>
          <span class="text-accent-cyan" id="amp${i}">${(h.amplitude * 100).toFixed(0)}%</span>
        </label>
        <input type="range" class="w-full" id="slider${i}" 
               min="0" max="100" value="${h.amplitude * 100}" data-index="${i}">
      `;
      container.appendChild(div);
      
      const slider = document.getElementById(`slider${i}`) as HTMLInputElement;
      slider.addEventListener('input', (e) => {
        const idx = parseInt((e.target as HTMLInputElement).dataset.index!);
        harmonics[idx].amplitude = parseInt((e.target as HTMLInputElement).value) / 100;
        document.getElementById(`amp${idx}`)!.textContent = 
          (harmonics[idx].amplitude * 100).toFixed(0) + '%';
        draw();
      });
    });
    
    document.getElementById('harmonicCount')!.textContent = harmonicCount.toString();
  }

  function draw() {
    drawWave();
    drawSpectrum();
  }

  function drawWave() {
    const w = waveCanvas.width;
    const h = waveCanvas.height;
    const centerY = h / 2;
    
    waveCtx.fillStyle = '#002b36';
    waveCtx.fillRect(0, 0, w, h);
    
    // ä¸­ç·š
    waveCtx.strokeStyle = '#586e75';
    waveCtx.lineWidth = 1;
    waveCtx.beginPath();
    waveCtx.moveTo(0, centerY);
    waveCtx.lineTo(w, centerY);
    waveCtx.stroke();
    
    // åˆæˆæ³¢
    waveCtx.strokeStyle = '#2aa198';
    waveCtx.lineWidth = 2;
    waveCtx.beginPath();
    
    for (let x = 0; x < w; x++) {
      const t = (x / w) * 4 * Math.PI;
      let y = 0;
      
      for (const h of harmonics) {
        y += h.amplitude * Math.sin(h.frequency * t);
      }
      
      const maxAmp = harmonics.reduce((sum, h) => sum + h.amplitude, 0) || 1;
      const normalizedY = centerY - (y / maxAmp) * (centerY - 20);
      
      if (x === 0) waveCtx.moveTo(x, normalizedY);
      else waveCtx.lineTo(x, normalizedY);
    }
    
    waveCtx.stroke();
    
    // å„è«§æ³¢
    harmonics.forEach((h, i) => {
      if (h.amplitude === 0) return;
      
      const colors = ['#dc322f', '#2aa198', '#b58900', '#6c71c4', '#268bd2', '#859900'];
      waveCtx.strokeStyle = colors[i % colors.length] + '80';
      waveCtx.lineWidth = 1;
      waveCtx.beginPath();
      
      for (let x = 0; x < w; x++) {
        const t = (x / w) * 4 * Math.PI;
        const y = h.amplitude * Math.sin(h.frequency * t);
        const maxAmp = harmonics.reduce((sum, h) => sum + h.amplitude, 0) || 1;
        const normalizedY = centerY - (y / maxAmp) * (centerY - 20);
        
        if (x === 0) waveCtx.moveTo(x, normalizedY);
        else waveCtx.lineTo(x, normalizedY);
      }
      
      waveCtx.stroke();
    });
  }

  function drawSpectrum() {
    const w = spectrumCanvas.width;
    const h = spectrumCanvas.height;
    
    specCtx.fillStyle = '#002b36';
    specCtx.fillRect(0, 0, w, h);
    
    const barWidth = w / (harmonicCount + 1);
    const maxAmp = Math.max(...harmonics.map(h => h.amplitude), 0.1);
    
    harmonics.forEach((harm, i) => {
      const barHeight = (harm.amplitude / maxAmp) * (h - 30);
      const x = (i + 0.5) * barWidth;
      
      const gradient = specCtx.createLinearGradient(x, h - barHeight, x, h);
      gradient.addColorStop(0, '#2aa198');
      gradient.addColorStop(1, '#073642');
      
      specCtx.fillStyle = gradient;
      specCtx.fillRect(x - barWidth * 0.35, h - barHeight - 20, barWidth * 0.7, barHeight);
      
      specCtx.fillStyle = '#93a1a1';
      specCtx.font = '12px Arial';
      specCtx.textAlign = 'center';
      specCtx.fillText(`${harm.frequency}f`, x, h - 5);
    });
  }

  function loadSquareWave() {
    harmonics.forEach((h, i) => {
      const n = i + 1;
      h.amplitude = (n % 2 === 1) ? 1 / n : 0;
    });
    renderControls();
    draw();
  }

  function loadSawtoothWave() {
    harmonics.forEach((h, i) => {
      const n = i + 1;
      h.amplitude = 1 / n;
    });
    renderControls();
    draw();
  }

  function loadTriangleWave() {
    harmonics.forEach((h, i) => {
      const n = i + 1;
      if (n % 2 === 1) {
        const sign = ((n - 1) / 2) % 2 === 0 ? 1 : -1;
        h.amplitude = Math.abs(sign / (n * n));
      } else {
        h.amplitude = 0;
      }
    });
    renderControls();
    draw();
  }

  document.getElementById('resetBtn')!.addEventListener('click', init);
  
  document.getElementById('addHarmonic')!.addEventListener('click', () => {
    if (harmonicCount < 20) {
      harmonicCount++;
      harmonics.push({ frequency: harmonicCount, amplitude: 0 });
      renderControls();
      draw();
    }
  });

  document.getElementById('removeHarmonic')!.addEventListener('click', () => {
    if (harmonicCount > 1) {
      harmonicCount--;
      harmonics.pop();
      renderControls();
      draw();
    }
  });

  document.getElementById('presetSquare')!.addEventListener('click', loadSquareWave);
  document.getElementById('presetSawtooth')!.addEventListener('click', loadSawtoothWave);
  document.getElementById('presetTriangle')!.addEventListener('click', loadTriangleWave);

  init();
</script>

<style>
  canvas {
    background: #002b36;
  }
</style>
