---
import BaseLayout from '@/layouts/BaseLayout.astro';
import Navbar from '@/components/Navbar.astro';
import '@/styles/game-common.css';
---
<BaseLayout
  title="ä¸‹æ¨“æ¢¯éŠæˆ² | æŒ«å±å‹‡çš„éŠæˆ²é–“"
  description="ç¶“å…¸åæ‡‰éŠæˆ²ã€Œä¸‹æ¨“æ¢¯ã€ï¼ŒæŒ‘æˆ°ä½ çš„åæ‡‰æ¥µé™ï¼æ˜¯ç”·äººå°±ä¸‹ 100 å±¤ã€‚æ”¯æ´è§¸æ§ã€éµç›¤ã€è¦å‰‡ AI èˆ‡å¼·åŒ–å­¸ç¿’ AI è‡ªå‹•éŠç©æ¨¡å¼ã€‚"
>
  <!-- è¼‰å…¥ TensorFlow.js for RL AI -->
  <script is:inline src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>
  <Navbar currentPage="game" />
  <div class="container-fluid mt-3">
    <div class="row justify-content-center">
      <div class="col-auto">
        <div class="game-container">
          <canvas id="gameCanvas" width="400" height="600"></canvas>
          <div class="game-overlay" id="startScreen">
            <h2>ğŸƒ ä¸‹æ¨“æ¢¯</h2>
            <p>ä¸è¦æ‰å‡ºå»ï¼Œä¹Ÿåˆ¥è¢«é ‚åˆ°é ‚éƒ¨ï¼</p>
            <button class="btn btn-lg btn-success" id="startBtn">é–‹å§‹éŠæˆ²</button>
            <button class="btn btn-lg btn-warning mt-2" id="aiStartBtn">ğŸ¤– è¦å‰‡ AI</button>
            <button class="btn btn-lg btn-info mt-2" id="rlAiStartBtn">ğŸ§  å¼·åŒ–å­¸ç¿’ AI</button>
            <div class="controls-info mt-3">
              <small>â† â†’ æˆ– A D ç§»å‹• | ç©ºç™½éµæš«åœ</small>
            </div>
            <div id="rlAiLoadingInfo" class="mt-2 hidden">
              <small class="text-info">ğŸ§  æ­£åœ¨è¼‰å…¥ RL æ¨¡å‹...</small>
            </div>
          </div>
          <div class="game-overlay hidden" id="gameOverScreen">
            <h2>ğŸ’€ éŠæˆ²çµæŸ</h2>
            <p>åˆ†æ•¸: <span id="finalScore">0</span></p>
            <p>æœ€é«˜åˆ†: <span id="highScore">0</span></p>
            <button class="btn btn-lg btn-primary" id="restartBtn">å†ç©ä¸€æ¬¡</button>
          </div>
          <div class="game-overlay hidden" id="pauseScreen">
            <h2>â¸ï¸ æš«åœ</h2>
            <p>æŒ‰ç©ºç™½éµç¹¼çºŒ</p>
          </div>
          <div class="score-display">
            <span id="aiIndicator" class="hidden">ğŸ¤– </span>
            <span id="scoreDisplay">0</span>
          </div>
        </div>

        <!-- AI é–‹ç™¼ç­†è¨˜ -->
        <div class="mt-4 text-center">
          <h5 class="text-muted mb-3">ğŸ¤– AI é–‹ç™¼ç­†è¨˜</h5>
          <div class="d-flex flex-column gap-2">
            <a href="/blog/stairs-ai-failure" class="btn btn-outline-warning btn-sm">
              ğŸ“– è¦å‰‡ AI çš„å¤±æ•—å¯¦é©—
            </a>
            <a href="/blog/stairs-rl-success" class="btn btn-outline-info btn-sm">
              ğŸ“ å¼·åŒ–å­¸ç¿’çš„æˆåŠŸä¹‹è·¯
            </a>
          </div>
          <p class="mt-3 text-muted small">
            äº†è§£å¾è¦å‰‡å¼•æ“åˆ°æ·±åº¦å¼·åŒ–å­¸ç¿’çš„å®Œæ•´æ­·ç¨‹
          </p>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>

<script>
  import { StairsGame } from '@/lib/games/StairsGame';
  import { StairsWeightsAgent } from '@/lib/ai/agents/StairsWeightsAgent';

  // RL AI æ”¯æ´
  let rlAgent: StairsWeightsAgent | null = null;
  let game: StairsGame | null = null;

  // è¼‰å…¥ RL AI
  const loadRLAgent = async () => {
    const loadingInfo = document.getElementById('rlAiLoadingInfo');
    const rlAiBtn = document.getElementById('rlAiStartBtn') as HTMLButtonElement;

    if (rlAgent) return; // å·²è¼‰å…¥

    try {
      loadingInfo?.classList.remove('hidden');
      rlAiBtn.disabled = true;
      rlAiBtn.textContent = 'ğŸ§  è¼‰å…¥ä¸­...';

      rlAgent = new StairsWeightsAgent({
        weightsPath: '/models/stairs/model_weights.json',
        deterministic: true
      });

      await rlAgent.load();

      rlAiBtn.textContent = 'ğŸ§  å¼·åŒ–å­¸ç¿’ AI';
      rlAiBtn.disabled = false;
      loadingInfo?.classList.add('hidden');

      console.log('âœ… RL AI loaded successfully');

      // é‡æ–°å‰µå»ºéŠæˆ²å¯¦ä¾‹ï¼Œé€™æ¬¡å‚³å…¥ RL agent
      game = new StairsGame(rlAgent);

      return true;
    } catch (error) {
      console.error('âŒ Failed to load RL AI:', error);
      rlAiBtn.textContent = 'ğŸ§  è¼‰å…¥å¤±æ•—';
      loadingInfo!.innerHTML = '<small class="text-danger">è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°</small>';
      return false;
    }
  };

  // RL AI æŒ‰éˆ•äº‹ä»¶
  document.getElementById('rlAiStartBtn')?.addEventListener('click', async () => {
    if (!rlAgent) {
      const loaded = await loadRLAgent();
      if (!loaded) return;
    }

    if (rlAgent && game) {
      // é–‹å§‹ RL AI æ¨¡å¼
      game.startGame('rl');
    }
  });

  // åˆå§‹åŒ–éŠæˆ²ï¼ˆæ²’æœ‰ RL agentï¼‰
  game = new StairsGame();

  // é è¼‰ RL AI (å¯é¸ - å–æ¶ˆè¨»è§£ä»¥æå‰è¼‰å…¥æ¨¡å‹)
  // setTimeout(() => loadRLAgent().catch(console.error), 1000);
</script>
