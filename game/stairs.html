<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>下樓梯遊戲</title>
    <style>
        canvas { background: #eee; display: block; margin: 0 auto; }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="400" height="600"></canvas>
    <script>
        function startGame() {
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            ctx.font = "16px Arial";

            const player = { x: 200, y: 100, width: 20, height: 20, dy: 2, speed: 5, onStair: false };
            const stairs = [];
            let gameOver = false;
            let gamePause = false;
            let keys = { left: false, right: false }; // 用來追蹤按鍵狀態

            let score = 0;

            function stairX() {
              return Math.random() * (canvas.width - 50);
            }

            function stairWidth() {
              return Math.random() * (canvas.width/3)+20;
            }

            function createStairs() {
                stairs.length = 0; // 清空樓梯陣列
                let y = 150;
                for (let i = 0; i < 10; i++) {
                    stairs.push({ x: stairX(), y: y, width: stairWidth(), height: 10 });
                    y += 60;
                }
            }

            function drawPlayer() {
                ctx.fillStyle = 'blue';
                ctx.fillRect(player.x, player.y, player.width, player.height);
            }

            function drawStairs() {
                ctx.fillStyle = 'brown';
                stairs.forEach(stair => {
                    ctx.fillRect(stair.x, stair.y, stair.width, stair.height);
                });
            }

            function checkCollision() {
                player.onStair = false;
                stairs.forEach(stair => {
                    if (
                        player.x < stair.x + stair.width &&
                        player.x + player.width > stair.x &&
                        player.y + player.height <= stair.y &&
                        player.y + player.height + player.dy >= stair.y
                    ) {
                        player.onStair = true;
                        player.y = stair.y - player.height; // 讓角色站在樓梯上
                    }
                });
            }

            function update() {
                if (gameOver) return;
                if (gamePause) return requestAnimationFrame(update);

                ctx.clearRect(0, 0, canvas.width, canvas.height);

                // 檢測碰撞
                checkCollision();

                // 如果角色不在樓梯上，則繼續下落
                player.y += player.dy * (player.onStair ? -1:1);

                // 角色左右移動
                if (keys.left) player.x -= player.speed;
                if (keys.right) player.x += player.speed;

                // 防止角色移出畫面
                player.x = Math.max(0, Math.min(player.x, canvas.width - player.width));

                // 樓梯移動
                stairs.forEach(stair => {
                    stair.y -= player.dy;
                    if (stair.y + stair.height < 0) {
                        stair.y = canvas.height;
                        stair.x = stairX();
                        stair.width = stairWidth();

                        score += 1;
                    }
                });
                ctx.fillText(score,10,16);


                // 遊戲結束條件：角色掉出畫面
                if (player.y > canvas.height) {
                    gameOver = true;
                    // alert('遊戲結束！');
                    return startGame();
                }

                drawPlayer();
                drawStairs();

                requestAnimationFrame(update);
            }

            createStairs();
            update();

            // 監聽按鍵點擊事件
            document.addEventListener('keypress', (e) => {
              if (e.key === ' ') gamePause = !gamePause;
            });

            // 監聽按鍵按下事件
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') keys.left = true;
                if (e.key === 'ArrowRight') keys.right = true;
            });

            // 監聽按鍵放開事件
            document.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowLeft') keys.left = false;
                if (e.key === 'ArrowRight') keys.right = false;
            });
        }

        // 預設啟動遊戲
        startGame();
    </script>
</body>
</html>
