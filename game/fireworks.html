<!doctype html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fireworks</title>
<style>
  html,body{margin:0;height:100%;background:#02040b;overflow:hidden;cursor:crosshair}
  canvas{display:block}
  .hint{position:fixed;left:10px;top:10px;color:#cfe3ff99;font:12px/1.2 system-ui,Segoe UI,Arial}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div class="hint">點擊/觸控放煙火</div>

<script>
(() => {
  const c = document.getElementById('c'), ctx = c.getContext('2d');
  let w, h, dpr;
  function resize(){
    dpr = Math.max(1, Math.min(2, devicePixelRatio || 1));
    w = innerWidth; h = innerHeight;
    c.width = Math.floor(w*dpr); c.height = Math.floor(h*dpr);
    c.style.width = w+'px'; c.style.height = h+'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  addEventListener('resize', resize); resize();

  const g = 0.045, fr = 0.985;
  const parts = [];
  const trails = [];
  const rnd = (a,b)=>a+Math.random()*(b-a);

  function boom(x,y){
    const n = Math.floor(rnd(60,110));
    const hue = rnd(0,360);
    for(let i=0;i<n;i++){
      const a = (i/n)*Math.PI*2 + rnd(-0.05,0.05);
      const sp = rnd(2.2,6.2) * (Math.random()**0.25);
      parts.push({
        x,y,
        vx: Math.cos(a)*sp,
        vy: Math.sin(a)*sp,
        life: rnd(45,95),
        hue,
        s: rnd(1.2,2.2)
      });
    }
    // 一點閃光碎片
    for(let i=0;i<12;i++){
      parts.push({x,y,vx:rnd(-1.2,1.2),vy:rnd(-1.2,1.2),life:rnd(12,22),hue, s:rnd(2.2,3.2), spark:1});
    }
  }

  function launch(x){
    const tx = x ?? rnd(w*0.1,w*0.9);
    const sx = tx + rnd(-80,80);
    const vy = rnd(-8.5,-11.5);
    const vx = (tx - sx)/rnd(35,55);
    const hue = rnd(0,360);
    parts.push({rocket:1,x:sx,y:h+10,vx,vy,life:rnd(40,60),hue});
  }

  function step(){
    // fade background
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = 'rgba(2,4,11,0.18)';
    ctx.fillRect(0,0,w,h);

    // draw faint stars
    ctx.fillStyle = 'rgba(255,255,255,0.04)';
    for(let i=0;i<2;i++) ctx.fillRect(rnd(0,w), rnd(0,h), 1, 1);

    // update & draw
    ctx.globalCompositeOperation = 'lighter';
    for(let i=parts.length-1;i>=0;i--){
      const p = parts[i];
      p.life -= 1;

      if(p.rocket){
        // trail
        trails.push({x:p.x,y:p.y,life:18,hue:p.hue});
        p.x += p.vx; p.y += p.vy;
        p.vy += g*0.35;
        if(p.life<0 || p.vy>-2.2){
          boom(p.x,p.y);
          parts.splice(i,1);
          continue;
        }
        // rocket dot
        ctx.fillStyle = `hsla(${p.hue},100%,70%,0.9)`;
        ctx.beginPath(); ctx.arc(p.x,p.y,2.2,0,Math.PI*2); ctx.fill();
      }else{
        p.x += p.vx; p.y += p.vy;
        p.vy += g;
        p.vx *= fr; p.vy *= fr;
        const a = Math.max(0, p.life/95);
        const light = p.spark ? 85 : 65;
        ctx.fillStyle = `hsla(${p.hue},100%,${light}%,${a})`;
        ctx.beginPath(); ctx.arc(p.x,p.y,p.s,0,Math.PI*2); ctx.fill();
        if(p.life<=0 || p.y>h+50) parts.splice(i,1);
      }
    }

    for(let i=trails.length-1;i>=0;i--){
      const t = trails[i]; t.life--;
      const a = Math.max(0,t.life/18);
      ctx.strokeStyle = `hsla(${t.hue},100%,70%,${a})`;
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(t.x, t.y);
      ctx.lineTo(t.x + rnd(-2,2), t.y + rnd(6,10));
      ctx.stroke();
      if(t.life<=0) trails.splice(i,1);
    }

    requestAnimationFrame(step);
  }
  step();

  // auto fireworks
  setInterval(() => launch(), 900);
  setInterval(() => launch(), 1500);

  function clickAt(x,y){
    // 直接在點擊處爆炸 + 發射一枚朝向那裡的火箭
    boom(x,y);
    const sx = x + rnd(-120,120);
    parts.push({rocket:1,x:sx,y:h+10,vx:(x-sx)/rnd(35,55),vy:rnd(-9,-12),life:rnd(35,55),hue:rnd(0,360)});
  }

  addEventListener('pointerdown', (e) => {
    const r = c.getBoundingClientRect();
    clickAt(e.clientX - r.left, e.clientY - r.top);
  }, {passive:true});
})();
</script>
</body>
</html>
